<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.2</storyId>
    <title>Configure GitHub Actions CI/CD Pipeline</title>
    <status>drafted</status>
    <generatedAt>2025-11-16</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-2-configure-github-actions-cicd-pipeline.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>solo developer maintaining dotmax long-term</asA>
    <iWant>automated CI/CD that tests across Windows, Linux, and macOS</iWant>
    <soThat>platform-specific bugs are caught immediately without manual testing</soThat>
    <tasks>
      <task id="1" acs="1">Create GitHub Actions workflow directory and file</task>
      <task id="2" acs="3">Configure build matrix for cross-platform testing</task>
      <task id="3" acs="6,7">Add Rust toolchain setup</task>
      <task id="4" acs="8">Implement build caching</task>
      <task id="5" acs="4">Add build and test steps</task>
      <task id="6" acs="4">Add code quality checks</task>
      <task id="7" acs="5">Add security audit step</task>
      <task id="8" acs="9,10">Validate CI performance and failure behavior</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">GitHub Actions workflow file exists at `.github/workflows/ci.yml`</criterion>
    <criterion id="2">CI runs on push to any branch and on pull requests</criterion>
    <criterion id="3">Build matrix tests on `[windows-latest, ubuntu-latest, macos-latest]`</criterion>
    <criterion id="4">Each platform runs: `cargo build`, `cargo test`, `cargo clippy -- -D warnings`, `cargo fmt --check`</criterion>
    <criterion id="5">CI includes `cargo audit` for security vulnerability scanning</criterion>
    <criterion id="6">CI uses Rust stable toolchain (auto-updated to latest)</criterion>
    <criterion id="7">CI includes MSRV check using `rust-version: 1.70` from Cargo.toml</criterion>
    <criterion id="8">CI uses caching (`Swatinem/rust-cache@v2`) for faster builds</criterion>
    <criterion id="9">CI fails if any check fails on any platform</criterion>
    <criterion id="10">CI completes in &lt;5 minutes for clean builds (with cache)</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Project Structure - CI/CD Workflows</section>
        <snippet>CI workflows located at .github/workflows/: ci.yml (main CI), benchmark.yml (Story 1.6), release.yml (Epic 7). Cross-platform testing is tier-1 requirement for Windows, Linux, macOS.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Decision Summary - MSRV 1.70</section>
        <snippet>rust-version = "1.70" enforced in CI. Prevents accidental use of newer Rust features. MSRV check separate from stable toolchain tests.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Testing Strategy</section>
        <snippet>Zero warnings policy with clippy -D warnings. All code must work identically on Windows, Linux, macOS. CI is the only way to validate for solo developer.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Security Architecture</section>
        <snippet>cargo-audit scans RustSec Advisory Database on every CI run. Detects known vulnerabilities in dependencies. Preventive security approach.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Success Criteria - Performance Excellence</section>
        <snippet>CI must complete in &lt;5 minutes for clean builds. Performance is make-or-break for entire product suite. Cache strategy critical for development velocity.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic 1 - Foundation &amp; Project Setup</title>
        <section>Story 1.2 - Technical Notes</section>
        <snippet>Use GitHub Actions (free for public repos). Matrix strategy for cross-platform testing. cargo-audit detects dependency vulnerabilities. Cache ~/.cargo and target/ for speed.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/1-1-initialize-cargo-project-with-optimal-structure.md</path>
        <title>Story 1.1 - Previous Story</title>
        <section>Learnings from Previous Story</section>
        <snippet>Cargo project created with edition 2021, MSRV 1.70, dual MIT/Apache-2.0 licensing. Directory structure (examples/, tests/, benches/, docs/) exists but empty. No dependencies yet (Story 1.3).</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>Cargo.toml</path>
        <kind>manifest</kind>
        <symbol>package metadata</symbol>
        <lines>1-14</lines>
        <reason>Contains rust-version = "1.70" that CI MSRV check must validate against. No dependencies yet, so CI will be minimal initially.</reason>
      </artifact>
      <artifact>
        <path>src/lib.rs</path>
        <kind>library entry point</kind>
        <symbol>lib crate root</symbol>
        <lines>1-17</lines>
        <reason>Minimal library with documentation. No code yet, but cargo build and cargo test should succeed (empty test suite).</reason>
      </artifact>
    </code>
    <dependencies>
      <rust>
        <toolchain>stable (primary), 1.70 (MSRV check)</toolchain>
        <components>rustfmt, clippy, rust-src</components>
        <note>No runtime dependencies yet. Story 1.3 will add ratatui and crossterm.</note>
      </rust>
      <github_actions>
        <action name="actions/checkout" version="v3">Checkout repository code</action>
        <action name="dtolnay/rust-toolchain" version="stable">Install Rust toolchain (stable and 1.70)</action>
        <action name="Swatinem/rust-cache" version="v2">Cache Cargo registry and build artifacts</action>
        <action name="rustsec/audit-check" version="v1.4.1">Security vulnerability scanning with cargo-audit</action>
      </github_actions>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="platform">CI must run on Windows, Linux, macOS (tier-1 platforms). Matrix strategy parallelizes testing.</constraint>
    <constraint type="performance">CI must complete in &lt;5 minutes with warm cache. First run (cold cache) can take 10-15 minutes.</constraint>
    <constraint type="quality">Zero warnings policy: clippy -D warnings treats all warnings as errors. Prevents technical debt accumulation.</constraint>
    <constraint type="formatting">cargo fmt --check enforces formatting. Fails CI if any file would be reformatted. Story 1.4 will create .rustfmt.toml config.</constraint>
    <constraint type="security">cargo-audit must fail CI on known vulnerabilities. Uses RustSec Advisory Database.</constraint>
    <constraint type="msrv">MSRV 1.70 must be validated in separate job. Uses cargo check (faster than full build), not cargo test.</constraint>
    <constraint type="caching">Swatinem/rust-cache@v2 caches ~/.cargo/registry, ~/.cargo/git, and target/ directories. Per-platform caching (Windows/Linux/macOS separate).</constraint>
    <constraint type="triggers">CI runs on push to any branch and on pull requests. Catches issues immediately during development.</constraint>
    <constraint type="github_limits">Public repos have unlimited GitHub Actions minutes. Windows uses 2× minutes, macOS uses 10× minutes (cost consideration if repo goes private).</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>GitHub Actions Workflow Structure</name>
      <kind>CI/CD Configuration</kind>
      <signature>
name: CI
on: [push, pull_request]
jobs:
  test: (matrix: [ubuntu, windows, macos])
    - checkout
    - rust-toolchain@stable
    - rust-cache@v2
    - cargo build
    - cargo test
  clippy: (ubuntu only)
    - cargo clippy -- -D warnings
  fmt: (ubuntu only)
    - cargo fmt --check
  audit: (ubuntu only)
    - cargo audit (via rustsec/audit-check)
  msrv: (ubuntu only, rust 1.70)
    - cargo check --all-features
      </signature>
      <path>.github/workflows/ci.yml</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Currently minimal testing (empty test suite from Story 1.1). CI validates build succeeds and tests pass. Story 1.4 will add quality tooling configs. Epic 2+ will add unit tests. Epic 7 will add comprehensive test suite with integration tests and benchmarks. CI must detect failures: compile errors, test failures, clippy warnings, formatting violations, security vulnerabilities.
    </standards>
    <locations>
      <location>tests/ - Integration tests (empty, will be populated in Epic 7)</location>
      <location>src/lib.rs - Unit tests via #[cfg(test)] modules (will be added in Epic 2+)</location>
      <location>.github/workflows/ci.yml - CI validation tests</location>
    </locations>
    <ideas>
      <idea ac="1,2">Verify .github/workflows/ci.yml file exists and is valid YAML</idea>
      <idea ac="3">Verify matrix includes all three platforms (windows-latest, ubuntu-latest, macos-latest)</idea>
      <idea ac="4">Verify all required cargo commands are present in workflow (build, test, clippy, fmt)</idea>
      <idea ac="5">Verify cargo audit step exists with rustsec/audit-check action</idea>
      <idea ac="6,7">Verify stable and 1.70 rust-toolchain configurations exist</idea>
      <idea ac="8">Verify Swatinem/rust-cache@v2 action is configured</idea>
      <idea ac="9">Test CI failure detection: introduce compile error, verify CI fails</idea>
      <idea ac="9">Test CI failure detection: add failing test, verify CI fails</idea>
      <idea ac="9">Test CI failure detection: add clippy warning, verify CI fails</idea>
      <idea ac="9">Test CI failure detection: introduce formatting violation, verify CI fails</idea>
      <idea ac="10">Measure CI run time with cold cache (should complete, even if &gt;5 min)</idea>
      <idea ac="10">Measure CI run time with warm cache (must be &lt;5 minutes)</idea>
    </ideas>
  </tests>
</story-context>
