<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>7</storyId>
    <title>Add Debug Logging and Tracing Support</title>
    <status>drafted</status>
    <generatedAt>2025-11-18</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-7-add-debug-logging-and-tracing-support.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer troubleshooting rendering issues</asA>
    <iWant>optional debug logging that traces operations</iWant>
    <soThat>I can diagnose problems without modifying library code</soThat>
    <tasks>
### Task 1: Verify tracing dependency and configure for library use (AC: #1, #5)
- Confirm `tracing = "0.1"` exists in Cargo.toml dependencies (from Story 1.3)
- Add `tracing-subscriber = "0.3"` to dev-dependencies for testing
- Verify library does NOT initialize subscriber (check src/lib.rs, no init code)
- Document in rustdoc that users must initialize subscriber

### Task 2: Instrument BrailleGrid operations with tracing (AC: #2, #3, #4)
- Add `#[instrument]` to `BrailleGrid::new(width, height)`
- Add `#[instrument(skip(self))]` to `clear()` method
- Add `#[instrument(skip(self))]` to `resize(new_width, new_height)`
- Add `#[instrument(skip(self))]` to `enable_color_support()`
- Add `info!()` logs for major operations (new, resize) at entry points
- Add `debug!()` logs for detailed flow (clear, enable_color_support)
- Do NOT add debug logs to `set_dot()` or `get_dot()` (hot paths per AC #4)
- Consider `trace!()` for hot paths if profiling shows zero impact

### Task 3: Instrument TerminalRenderer operations with tracing (AC: #2, #3)
- Add `#[instrument(skip(self, grid))]` to `render(grid: &BrailleGrid)`
- Add `info!()` log at start of render: grid dimensions, cell count
- Add `debug!()` logs for rendering pipeline steps (unicode conversion, color application)
- Add `#[instrument]` to `get_terminal_size()`
- Add `debug!()` log for terminal size detection

### Task 4: Add error and warning logs (AC: #3)
- Add `error!()` logs before returning errors in grid.rs (OutOfBounds, InvalidDimensions)
- Add `error!()` logs before returning errors in render.rs (Terminal errors)
- Add `warn!()` logs for degraded operation (e.g., terminal lacks Unicode support - if detectable)
- Include error context in log messages (coordinates, dimensions, error details)

### Task 5: Create logging demonstration example (AC: #5, #6)
- Create `examples/logging_demo.rs`
- Configure `tracing-subscriber::fmt()` in example
- Set log level to DEBUG or TRACE
- Run dotmax operations (create grid, set dots, resize, render)
- Output demonstrates trace of operations
- Add documentation explaining logging setup for users

### Task 6: Write tests verifying logging infrastructure (AC: #6)
- Add test in src/grid.rs that enables tracing-subscriber for debugging
- Verify instrumentation compiles (no type errors with #[instrument])
- Test that logging works when subscriber initialized
- Test that logging is silent when subscriber NOT initialized (zero-cost)
- Document how to enable logging in tests for debugging failures

### Task 7: Document logging usage in README and rustdoc (AC: #5)
- Add "Logging" section to README.md
- Explain that dotmax uses `tracing` crate
- Show example of initializing subscriber in user code
- Link to tracing documentation
- Add rustdoc to lib.rs explaining logging setup

### Task 8: Run quality checks and verify implementation (AC: all)
- `cargo test` - all tests pass
- `cargo clippy -- -D warnings` - zero warnings
- `cargo fmt --check` - formatted correctly
- Verify zero panics (all operations still return Result or safe primitives)
- Verify hot paths have NO debug logs (only trace if any)
- CI passes on Windows, Linux, macOS
- Confirm no performance regression from logging (should be zero-cost when disabled)
</tasks>
  </story>

  <acceptanceCriteria>
AC 2.7.1: `tracing` dependency used for structured logging (already in Cargo.toml from Story 1.3)

AC 2.7.2: Key functions instrumented with `#[instrument]` attribute: `BrailleGrid::new()`, `TerminalRenderer::render()`

AC 2.7.3: Log levels used appropriately: `error!` (failures), `warn!` (degraded operation), `info!` (major ops), `debug!` (detailed flow)

AC 2.7.4: Hot paths (`set_dot`, `get_dot`) do NOT log at debug level (only trace if needed)

AC 2.7.5: Library does NOT initialize tracing subscriber (user controls logging)

AC 2.7.6: Tests can enable logging via `tracing-subscriber` for debugging test failures
</acceptanceCriteria>

  <artifacts>
    <docs>
      <artifact>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic 2 Technical Specification</title>
        <section>Story 2.7: Add Debug Logging and Tracing Support</section>
        <snippet>Story 2.7 adds structured logging using the #[instrument] attribute. Key functions instrumented: BrailleGrid::new(), TerminalRenderer::render(). Log levels: error (failures), warn (degraded), info (major ops), debug (detailed flow). Hot paths (set_dot, get_dot) have NO debug logs per NFR-O3.</snippet>
      </artifact>
      <artifact>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic 2 Technical Specification</title>
        <section>NFR-O1: Structured Logging with tracing</section>
        <snippet>Log levels: error (op failed), warn (unexpected but recoverable), info (major operations like "Grid created: 80Ã—24"), debug (detailed flow like "Converting cell"), trace (hot path internals - only if needed). Zero-cost when disabled.</snippet>
      </artifact>
      <artifact>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic 2 Technical Specification</title>
        <section>NFR-O3: No Logging in Hot Paths (Without TRACE)</section>
        <snippet>set_dot() and get_dot() do NOT log at debug level (called thousands of times). Use trace! level only if profiling shows no performance impact. Rendering pipeline logs at debug! level (called once per frame).</snippet>
      </artifact>
      <artifact>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic 2 Technical Specification</title>
        <section>NFR-O4: User Control Over Logging</section>
        <snippet>Library uses tracing crate - does NOT initialize subscriber. Application controls log level via tracing-subscriber. Default: No logging output unless user initializes subscriber. Example shows user code calling tracing_subscriber::fmt().with_max_level(DEBUG).init().</snippet>
      </artifact>
      <artifact>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>FR60: Debug/trace logging support</section>
        <snippet>The system provides debug/trace logging for troubleshooting (via log crate or similar). Enables developers to diagnose problems without modifying library code.</snippet>
      </artifact>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Logging Strategy</section>
        <snippet>Use tracing crate for structured logging. Instrument functions with #[instrument]. Log levels: error (operation failed), warn (unexpected), info (major operations), debug (detailed flow), trace (hot path internals). Library does NOT initialize subscriber - users control logging via tracing-subscriber.</snippet>
      </artifact>
    </docs>
    <code>
      <artifact>
        <path>src/grid.rs</path>
        <kind>module</kind>
        <symbol>BrailleGrid</symbol>
        <lines>1-100+</lines>
        <reason>Core struct that needs instrumentation: new(), clear(), resize(), enable_color_support(). Hot paths set_dot/get_dot must NOT have debug logs.</reason>
      </artifact>
      <artifact>
        <path>src/render.rs</path>
        <kind>module</kind>
        <symbol>TerminalRenderer</symbol>
        <lines>1-100+</lines>
        <reason>Core rendering struct that needs instrumentation: render(), get_terminal_size(). Rendering pipeline steps need debug logging for tracing flow.</reason>
      </artifact>
      <artifact>
        <path>src/error.rs</path>
        <kind>module</kind>
        <symbol>DotmaxError</symbol>
        <lines>1-177</lines>
        <reason>Error types that need error! logs before being returned. All error variants should log with context before propagating.</reason>
      </artifact>
      <artifact>
        <path>Cargo.toml</path>
        <kind>manifest</kind>
        <symbol>dependencies</symbol>
        <lines>13-18</lines>
        <reason>Verify tracing dependency exists (line 18). Add tracing-subscriber to dev-dependencies for testing and examples.</reason>
      </artifact>
    </code>
    <dependencies>
      <rust>
        <package name="tracing" version="0.1" scope="core">Structured logging framework for instrumentation</package>
        <package name="tracing-subscriber" version="0.3" scope="dev">Log formatting and output for examples and tests</package>
        <package name="thiserror" version="2.0" scope="core">Error handling (already in use)</package>
        <package name="ratatui" version="0.29" scope="core">Terminal framework (already in use)</package>
        <package name="crossterm" version="0.29" scope="core">Terminal I/O (already in use)</package>
      </rust>
    </dependencies>
  </artifacts>

  <constraints>
- **Zero-Cost When Disabled**: Logging must be compile-time feature gated. No runtime overhead when subscriber not initialized (NFR-O3).
- **No Hot Path Logging at Debug Level**: set_dot() and get_dot() are called thousands of times per render. Do NOT add debug logs. Only trace! if profiling confirms zero impact (AC 2.7.4).
- **Library Does NOT Initialize Subscriber**: User code must call tracing_subscriber::fmt().init(). Library only emits trace events (AC 2.7.5).
- **Zero Panics Policy**: All operations still return Result<T, DotmaxError>. No panics introduced by logging instrumentation (NFR-R1).
- **Error Context**: All error! logs must include actionable context (coordinates, dimensions, error details) per NFR-O2.
- **Cross-Platform**: Logging works identically on Windows, Linux, macOS (NFR-R2).
- **Performance Target**: Confirm no performance regression. Logging disabled should have exactly zero runtime cost (NFR-P3, NFR-P4).
  </constraints>

  <interfaces>
- **tracing::instrument macro**: Applied to key functions (BrailleGrid::new, TerminalRenderer::render) with skip(self) for methods.
- **tracing macros**: error!, warn!, info!, debug!, trace! used at appropriate levels per NFR-O1.
- **tracing-subscriber (user code)**: Users must initialize via tracing_subscriber::fmt().with_max_level(Level::DEBUG).init() to see logs.
- **Instrumented functions signature**: #[instrument] or #[instrument(skip(self))] attribute. No signature changes to existing public API.
  </interfaces>

  <tests>
    <standards>
Dotmax uses Rust's built-in test framework with #[test] attributes. Test modules placed in #[cfg(test)] mod tests blocks. Integration tests in tests/ directory. Logging tests should:
1. Verify instrumentation compiles (#[instrument] attributes work)
2. Test silent by default (no subscriber = no output)
3. Test logging works when subscriber initialized (tracing_subscriber::fmt().try_init())
4. Document how to enable logging in tests for debugging (--nocapture flag)
    </standards>
    <locations>
- src/grid.rs - #[cfg(test)] mod tests (logging infrastructure tests)
- src/render.rs - #[cfg(test)] mod tests (logging infrastructure tests)
- tests/integration_tests.rs - integration test with logging enabled
- examples/logging_demo.rs - demonstration example (runnable, shows logging in action)
    </locations>
    <ideas>
**Test Ideas Mapped to Acceptance Criteria:**

AC 2.7.1 (tracing dependency):
- Verify Cargo.toml contains tracing = "0.1" in dependencies
- Verify tracing-subscriber = "0.3" in dev-dependencies

AC 2.7.2 (instrumented functions):
- Test that BrailleGrid::new compiles with #[instrument]
- Test that TerminalRenderer::render compiles with #[instrument(skip(self, grid))]
- Verify no type errors from instrumentation

AC 2.7.3 (log levels):
- Manual review: Check that error! used before Err returns
- Manual review: Check that info! used for major ops (new, render)
- Manual review: Check that debug! used for detailed flow

AC 2.7.4 (hot paths):
- Code review: Verify set_dot() has NO debug! logs
- Code review: Verify get_dot() has NO debug! logs
- Only trace! allowed in hot paths

AC 2.7.5 (no subscriber init):
- Grep src/lib.rs for "tracing_subscriber" - should be ZERO matches
- Test logging silent by default (no subscriber = no output)

AC 2.7.6 (test logging):
- Integration test enables tracing-subscriber
- Test verifies operations complete successfully with logging
- Document --nocapture for viewing logs in test output
    </ideas>
  </tests>
</story-context>
