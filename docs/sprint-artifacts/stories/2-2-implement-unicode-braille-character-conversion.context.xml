<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2</storyId>
    <title>Implement Unicode Braille Character Conversion</title>
    <status>drafted</status>
    <generatedAt>2025-11-17</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-2-implement-unicode-braille-character-conversion.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>library developer extracting proven code</asA>
    <iWant>to implement Unicode braille character conversion from dot patterns</iWant>
    <soThat>BrailleGrid can render dots as terminal-displayable characters</soThat>
    <tasks>
- Task 1: COPY Unicode conversion logic from crabmusic (AC: #1, #4)
- Task 2: Adapt crabmusic conversion to dotmax structure (AC: #1)
- Task 3: Implement `to_unicode_grid()` method (AC: #2)
- Task 4: Implement `cell_to_braille_char()` method (AC: #3)
- Task 5: Write comprehensive unit tests (AC: #4, #5)
- Task 6: Create criterion benchmark (AC: #6)
- Task 7: Run quality checks and verify correctness (AC: #4, #5, #6)
    </tasks>
  </story>

  <acceptanceCriteria>
1. `src/grid.rs` contains function to convert 8-dot array to Unicode braille using bitfield formula: `U+2800 + (dots[0]<<0 | dots[1]<<1 | ... | dots[7]<<7)`
2. `BrailleGrid::to_unicode_grid() -> Vec<Vec<char>>` converts entire grid to 2D char array
3. `BrailleGrid::cell_to_braille_char(x, y) -> Result<char, DotmaxError>` converts single cell to Unicode
4. Conversion is correct for all 256 braille patterns (2^8 combinations)
5. Unit tests verify: empty cell → U+2800, full cell → U+28FF, specific patterns match Unicode standard
6. Benchmark (`benches/rendering.rs`) shows conversion <1μs per cell (criterion test passes)
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <artifact path="docs/PRD.md" title="Product Requirements Document" section="FR5: Unicode Braille Conversion" snippet="The system converts braille dot patterns to Unicode braille characters (U+2800 to U+28FF range)" />
      <artifact path="docs/PRD.md" title="Product Requirements Document" section="NFR-P1: Rendering Latency" snippet="Image-to-braille conversion: &lt;25ms target, &lt;50ms maximum for standard terminals (80×24)" />
      <artifact path="docs/architecture.md" title="Architecture Document" section="ADR 0001: Use Unicode Braille" snippet="Use Unicode braille characters (U+2800-U+28FF) for rendering. Each braille character represents a 2×4 dot matrix, providing 4× the resolution of ASCII art." />
      <artifact path="docs/architecture.md" title="Architecture Document" section="Pattern 1: Braille Dot Matrix Mapping" snippet="Dot Coordinate System with mapping: cell_x = x / 2, cell_y = y / 4. Unicode formula: U+2800 + bitfield where bitfield = dots[0]&lt;&lt;0 | dots[1]&lt;&lt;1 | ... | dots[7]&lt;&lt;7" />
      <artifact path="docs/sprint-artifacts/tech-spec-epic-2.md" title="Epic 2 Technical Specification" section="Story 2.2: Unicode Conversion" snippet="AC 2.2.1: Contains function to convert 8-dot array to Unicode braille using bitfield formula. AC 2.2.6: Benchmark shows conversion &lt;1μs per cell" />
      <artifact path="docs/sprint-artifacts/tech-spec-epic-2.md" title="Epic 2 Technical Specification" section="Unicode Conversion Algorithm" snippet="Step 1: Calculate bitfield = dots[0]&lt;&lt;0 | dots[1]&lt;&lt;1 | ... | dots[7]&lt;&lt;7. Step 2: unicode_value = 0x2800 + bitfield" />
      <artifact path="docs/sprint-artifacts/tech-spec-epic-2.md" title="Epic 2 Technical Specification" section="Extraction Mapping" snippet="crabmusic/src/visualization/braille.rs (~500 lines) → dotmax/src/grid.rs with Unicode conversion logic" />
    </docs>
    <code>
      <artifact path="src/grid.rs" kind="module" symbol="BrailleGrid" lines="178-474" reason="Core grid structure from Story 2.1 - Story 2.2 will add Unicode conversion methods to this struct" />
      <artifact path="src/grid.rs" kind="function" symbol="dots_to_char" lines="134-139" reason="Existing Unicode conversion function extracted from crabmusic - may need to be adapted or wrapped for new methods" />
      <artifact path="src/grid.rs" kind="method" symbol="BrailleGrid::get_char" lines="440-447" reason="Existing method that converts cell to Unicode - shows current usage of dots_to_char" />
      <artifact path="src/grid.rs" kind="error" symbol="DotmaxError" lines="24-39" reason="Error types that new methods must return for bounds checking and validation" />
      <artifact path="src/lib.rs" kind="file" symbol="N/A" lines="1-49" reason="Public API exports - Story 2.2 methods will be re-exported here" />
      <artifact path="benches/rendering.rs" kind="benchmark" symbol="bench_unicode_conversion" lines="40-52" reason="Placeholder benchmark that Story 2.2 will replace with actual BrailleGrid conversion benchmarks" />
      <artifact path="crabmusic/src/visualization/braille.rs" kind="reference" symbol="Unicode conversion logic" lines="N/A" reason="Source code to extract Unicode conversion implementation from (copy-replace strategy per ADR 0005)" />
    </code>
    <dependencies>
      <rust>
        <package name="criterion" version="0.7" purpose="Benchmarking framework for AC 2.2.6 performance validation" />
        <package name="thiserror" version="2.0" purpose="Error handling for Result types in new methods" />
      </rust>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="performance" source="NFR-P1">Unicode conversion must complete in &lt;1μs per cell (80×24 grid = 1,920 cells = 1.92ms total)</constraint>
    <constraint type="architecture" source="ADR 0005">MUST follow copy-replace strategy: copy exact Unicode conversion logic from crabmusic, do NOT write from scratch</constraint>
    <constraint type="quality" source="NFR-S3">Zero panics policy - all public methods return Result, never panic</constraint>
    <constraint type="testing" source="AC 2.2.4">Exhaustive testing required - all 256 braille patterns (2^8 combinations) must be tested</constraint>
    <constraint type="extraction" source="Story 2.2 Dev Notes">Code must document source location in crabmusic with line numbers in comments</constraint>
    <constraint type="pattern" source="Architecture Pattern 1">Use bitfield formula: U+2800 + (dots[0]&lt;&lt;0 | dots[1]&lt;&lt;1 | ... | dots[7]&lt;&lt;7)</constraint>
    <constraint type="integration" source="Story 2.1">Build on existing BrailleGrid struct - add methods, don't modify core structure</constraint>
  </constraints>

  <interfaces>
    <interface name="to_unicode_grid" kind="method" signature="pub fn to_unicode_grid(&amp;self) -&gt; Vec&lt;Vec&lt;char&gt;&gt;" path="src/grid.rs" description="Converts entire BrailleGrid to 2D array of Unicode braille characters. Iterates through all cells and applies dots_to_char conversion." />
    <interface name="cell_to_braille_char" kind="method" signature="pub fn cell_to_braille_char(&amp;self, x: usize, y: usize) -&gt; Result&lt;char, DotmaxError&gt;" path="src/grid.rs" description="Converts single cell at (x,y) to Unicode braille character with bounds validation. Returns OutOfBounds error if coordinates invalid." />
    <interface name="dots_to_braille_char" kind="helper" signature="fn dots_to_braille_char(dots: &amp;[bool; 8]) -&gt; char" path="src/grid.rs" description="Helper function to convert 8-dot boolean array to Unicode character. Extracted from crabmusic with adaptation for [bool; 8] parameter type." />
    <interface name="DotmaxError::OutOfBounds" kind="error" signature="OutOfBounds { x: usize, y: usize, width: usize, height: usize }" path="src/grid.rs" description="Error variant for out-of-bounds cell access in cell_to_braille_char method" />
  </interfaces>
  <tests>
    <standards>Rust unit testing with #[test] attribute in #[cfg(test)] modules. Criterion.rs for performance benchmarks. All tests must pass before merge. Zero panics policy enforced - tests cover error cases exhaustively. Story 2.1 established 80%+ line coverage baseline with 100% coverage for critical paths.</standards>
    <locations>
      <location>src/grid.rs - Unit tests in #[cfg(test)] mod tests (lines 486-831)</location>
      <location>benches/rendering.rs - Criterion benchmarks (currently placeholder, Story 2.2 will update)</location>
    </locations>
    <ideas>
      <test ac="2.2.1" idea="Test bitfield calculation correctness: verify dots[0]&lt;&lt;0 | dots[1]&lt;&lt;1 | ... | dots[7]&lt;&lt;7 produces correct values for known patterns" />
      <test ac="2.2.2" idea="Test to_unicode_grid() dimensions: create 5×5 grid, verify result is 5×5 Vec&lt;Vec&lt;char&gt;&gt;" />
      <test ac="2.2.2" idea="Test to_unicode_grid() content: set specific dot patterns, verify resulting characters match expected Unicode values" />
      <test ac="2.2.3" idea="Test cell_to_braille_char() valid cells: convert cells at various positions (0,0), (5,5), (width-1, height-1) and verify correct characters" />
      <test ac="2.2.3" idea="Test cell_to_braille_char() bounds validation: out-of-bounds access returns Err(OutOfBounds) with correct context" />
      <test ac="2.2.4" idea="Test all 256 patterns exhaustively: for bitfield in 0..=255, convert to dots array, call conversion, verify result = char::from_u32(0x2800 + bitfield)" />
      <test ac="2.2.5" idea="Test empty cell (all false dots) converts to U+2800 '⠀'" />
      <test ac="2.2.5" idea="Test full cell (all true dots) converts to U+28FF '⣿'" />
      <test ac="2.2.5" idea="Test specific patterns: dots[0,2]=true → U+2805 '⠅', dots[0-3]=true → U+280F '⠏'" />
      <test ac="2.2.6" idea="Benchmark: replace bench_unicode_conversion placeholder with actual BrailleGrid::to_unicode_grid() on 80×24 grid" />
      <test ac="2.2.6" idea="Benchmark: cell_to_braille_char() throughput - measure per-cell conversion time, verify &lt;1μs target" />
      <test ac="2.2.6" idea="Benchmark: helper function dots_to_braille_char() - measure raw conversion speed without grid overhead" />
    </ideas>
  </tests>
</story-context>
