<story-context id="bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>7</epicId>
    <storyId>6</storyId>
    <title>Publish to crates.io and Create Release Process</title>
    <status>drafted</status>
    <generatedAt>2025-11-26</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/7-6-publish-to-cratesio-and-create-release-process.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>library maintainer</asA>
    <iWant>an automated release process that publishes to crates.io</iWant>
    <soThat>users can easily install dotmax via `cargo add` and trust the release quality</soThat>
    <tasks>
      <task id="1" name="Prepare Cargo.toml for Publication" acs="2,4">
        <subtask id="1.1">Update version to "0.1.0"</subtask>
        <subtask id="1.2">Verify package metadata (name, description, license, repository)</subtask>
        <subtask id="1.3">Verify keywords (5 max: terminal, braille, graphics, cli, visualization)</subtask>
        <subtask id="1.4">Verify categories (command-line-interface, graphics, rendering)</subtask>
        <subtask id="1.5">Verify documentation URL (https://docs.rs/dotmax)</subtask>
        <subtask id="1.6">Verify homepage/repository URLs point to GitHub</subtask>
        <subtask id="1.7">Verify rust-version = "1.70" (MSRV)</subtask>
        <subtask id="1.8">Add exclude patterns for unnecessary files (.github, docs/sprint-artifacts, etc.)</subtask>
      </task>
      <task id="2" name="Create CHANGELOG.md" acs="3">
        <subtask id="2.1">Create CHANGELOG.md in project root</subtask>
        <subtask id="2.2">Add header following Keep a Changelog format</subtask>
        <subtask id="2.3">Write v0.1.0 release notes with date</subtask>
        <subtask id="2.4">Document Epic 1 - Foundation features</subtask>
        <subtask id="2.5">Document Epic 2 - Core Braille Rendering features</subtask>
        <subtask id="2.6">Document Epic 3 - Image Rendering Pipeline features</subtask>
        <subtask id="2.7">Document Epic 4 - Drawing Primitives features</subtask>
        <subtask id="2.8">Document Epic 5 - Color System features</subtask>
        <subtask id="2.9">Document Epic 6 - Animation System features</subtask>
        <subtask id="2.10">Document Epic 7 - API and Performance features</subtask>
        <subtask id="2.11">Add links to docs.rs, GitHub releases</subtask>
      </task>
      <task id="3" name="Run Pre-Publication Checklist" acs="1">
        <subtask id="3.1">Run cargo test --all-features - verify all tests pass</subtask>
        <subtask id="3.2">Run cargo clippy --all-features -- -D warnings - verify zero warnings</subtask>
        <subtask id="3.3">Run RUSTDOCFLAGS="-D warnings" cargo doc --no-deps --all-features - verify docs build</subtask>
        <subtask id="3.4">Run cargo test --doc - verify all doctests pass</subtask>
        <subtask id="3.5">Run cargo bench --all-features - verify benchmarks complete</subtask>
        <subtask id="3.6">Run cargo audit - verify no security vulnerabilities</subtask>
        <subtask id="3.7">Run cargo deny check - verify license compliance</subtask>
        <subtask id="3.8">Document all checklist results in story</subtask>
      </task>
      <task id="4" name="Validate Dry-Run Publication" acs="4">
        <subtask id="4.1">Run cargo publish --dry-run - verify success</subtask>
        <subtask id="4.2">Review package contents listed</subtask>
        <subtask id="4.3">Verify package size is reasonable</subtask>
        <subtask id="4.4">Fix any missing file or metadata errors</subtask>
        <subtask id="4.5">Re-run dry-run after any fixes</subtask>
      </task>
      <task id="5" name="Create GitHub Actions Release Workflow" acs="5">
        <subtask id="5.1">Create .github/workflows/release.yml</subtask>
        <subtask id="5.2">Configure trigger on tag push (v*)</subtask>
        <subtask id="5.3">Add checkout step</subtask>
        <subtask id="5.4">Add Rust toolchain setup (stable)</subtask>
        <subtask id="5.5">Add full test suite step (cargo test --all-features)</subtask>
        <subtask id="5.6">Add clippy check step</subtask>
        <subtask id="5.7">Add documentation build step</subtask>
        <subtask id="5.8">Add cargo publish step with CARGO_REGISTRY_TOKEN secret</subtask>
        <subtask id="5.9">Add GitHub release creation step (softprops/action-gh-release)</subtask>
        <subtask id="5.10">Configure release notes from CHANGELOG.md</subtask>
      </task>
      <task id="6" name="Prepare GitHub Repository" acs="7">
        <subtask id="6.1">Ensure repository is public</subtask>
        <subtask id="6.2">Verify CARGO_REGISTRY_TOKEN secret is configured (or document requirement)</subtask>
        <subtask id="6.3">Verify repository description matches crate description</subtask>
        <subtask id="6.4">Add relevant topics/tags to repository</subtask>
      </task>
      <task id="7" name="Publish to crates.io" acs="6,8">
        <subtask id="7.1">Create and push annotated tag: git tag -a v0.1.0 -m "Release v0.1.0"</subtask>
        <subtask id="7.2">Push tag: git push origin v0.1.0</subtask>
        <subtask id="7.3">Monitor CI release workflow execution</subtask>
        <subtask id="7.4">Verify crate appears on crates.io</subtask>
        <subtask id="7.5">Verify docs.rs builds successfully</subtask>
        <subtask id="7.6">Verify GitHub release is created with notes</subtask>
      </task>
      <task id="8" name="Post-Release Verification" acs="9">
        <subtask id="8.1">Create fresh test project: cargo new test-dotmax</subtask>
        <subtask id="8.2">Install dotmax: cargo add dotmax</subtask>
        <subtask id="8.3">Verify basic hello_braille example works</subtask>
        <subtask id="8.4">Install with features: cargo add dotmax -F image</subtask>
        <subtask id="8.5">Verify image rendering example works</subtask>
        <subtask id="8.6">Install with all features: cargo add dotmax -F image,svg</subtask>
        <subtask id="8.7">Document verification results</subtask>
        <subtask id="8.8">Clean up test project</subtask>
      </task>
      <task id="9" name="Final Documentation Updates" acs="All">
        <subtask id="9.1">Update README.md with crates.io badge (after publication)</subtask>
        <subtask id="9.2">Update README.md with docs.rs badge</subtask>
        <subtask id="9.3">Update README.md with version badge</subtask>
        <subtask id="9.4">Verify all links to crates.io work</subtask>
        <subtask id="9.5">Document all 9 ACs with evidence</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1" title="Pre-publication checklist passes">
      <requirement>All tests pass (cargo test --all-features)</requirement>
      <requirement>Zero clippy warnings (cargo clippy --all-features -- -D warnings)</requirement>
      <requirement>Documentation builds (cargo doc --no-deps --all-features)</requirement>
      <requirement>Benchmarks complete without errors (cargo bench)</requirement>
      <requirement>Security audit passes (cargo audit)</requirement>
      <requirement>License check passes (cargo deny check)</requirement>
    </criterion>
    <criterion id="AC2" title="Version set to 0.1.0">
      <requirement>Cargo.toml version = "0.1.0"</requirement>
      <requirement>Version follows semantic versioning (0.x allows breaking changes)</requirement>
      <requirement>MSRV (rust-version) properly set to 1.70</requirement>
    </criterion>
    <criterion id="AC3" title="CHANGELOG.md updated">
      <requirement>Contains 0.1.0 release notes</requirement>
      <requirement>Lists all major features by epic</requirement>
      <requirement>Documents breaking changes (if any)</requirement>
      <requirement>Links to docs.rs documentation</requirement>
    </criterion>
    <criterion id="AC4" title="Dry-run succeeds">
      <requirement>cargo publish --dry-run exits 0</requirement>
      <requirement>No missing files or metadata errors</requirement>
      <requirement>Package size reasonable (less than 10MB)</requirement>
    </criterion>
    <criterion id="AC5" title="Release workflow exists">
      <requirement>.github/workflows/release.yml triggers on tag push (v*)</requirement>
      <requirement>Runs full test suite before publishing</requirement>
      <requirement>Publishes to crates.io via cargo publish</requirement>
      <requirement>Creates GitHub release with notes</requirement>
    </criterion>
    <criterion id="AC6" title="Published to crates.io">
      <requirement>cargo add dotmax works in any project</requirement>
      <requirement>Package visible on crates.io/crates/dotmax</requirement>
      <requirement>Correct metadata (description, keywords, categories)</requirement>
    </criterion>
    <criterion id="AC7" title="GitHub release created">
      <requirement>Tag v0.1.0 exists and is annotated</requirement>
      <requirement>GitHub release page has release notes</requirement>
      <requirement>Links to documentation and changelog</requirement>
    </criterion>
    <criterion id="AC8" title="docs.rs builds">
      <requirement>Documentation available at docs.rs/dotmax</requirement>
      <requirement>All features documented</requirement>
      <requirement>No build errors on docs.rs</requirement>
    </criterion>
    <criterion id="AC9" title="Post-release verification">
      <requirement>Installation tested in clean environment</requirement>
      <requirement>Verify cargo add dotmax in new project</requirement>
      <requirement>Verify basic functionality works</requirement>
      <requirement>Verify feature flags work (cargo add dotmax -F image,svg)</requirement>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/architecture.md" title="Architecture Document" section="Deployment Architecture" snippet="Dotmax is a library crate distributed via crates.io. Release process: tag push triggers CI validation, cargo publish, and GitHub release creation." />
      <doc path="docs/PRD.md" title="Product Requirements Document" section="Library Distribution &amp; Packaging" snippet="FR61-FR67: cargo add dotmax from crates.io, binary size &lt;2MB, minimal dependencies, feature flags, stable Rust, API documentation via rustdoc." />
      <doc path="docs/sprint-artifacts/tech-spec-epic-7.md" title="Epic 7 Technical Specification" section="Story 7.6" snippet="Complete technical specification for publication including pre-publication checklist, release workflow API, dependency security validation, and acceptance criteria mapping." />
      <doc path="README.md" title="README" section="Installation" snippet="Already includes cargo add dotmax instructions and badges (placeholder URLs). Ready for publication - just needs real crates.io URLs after release." />
      <doc path="CHANGELOG.md" title="Changelog" section="Unreleased" snippet="Currently has [Unreleased] section listing all features by Epic. Needs to be converted to [0.1.0] - 2025-11-26 format for release." />
      <doc path="docs/getting_started.md" title="Getting Started Guide" section="Installation" snippet="Tutorial walkthrough for new users - already complete from Story 7.5." />
      <doc path="docs/performance.md" title="Performance Guide" section="Benchmarks" snippet="Performance optimization guide with benchmark results - already complete from Story 7.5." />
      <doc path="docs/troubleshooting.md" title="Troubleshooting Guide" section="Common Issues" snippet="Common issues and solutions - already complete from Story 7.5." />
    </docs>
    <code>
      <file path="Cargo.toml" kind="manifest" symbol="[package]" lines="1-30" reason="Main package manifest - version is already 0.1.0, all metadata in place. Need to verify and add exclude patterns." />
      <file path="src/lib.rs" kind="public-api" symbol="pub mod/use" lines="1-139" reason="Public API surface - already has #![warn(missing_docs)] and comprehensive rustdoc. All public types re-exported." />
      <file path=".github/workflows/ci.yml" kind="ci-workflow" symbol="jobs" lines="1-146" reason="CI workflow - comprehensive with test, clippy, fmt, audit, msrv, deny, coverage jobs. Already production-ready." />
      <file path=".github/workflows/benchmark.yml" kind="benchmark-workflow" symbol="benchmark/regression-check" lines="1-144" reason="Benchmark workflow - runs on main branch, stores artifacts, detects regressions. Already complete from Story 7.2." />
      <file path="deny.toml" kind="config" symbol="[advisories]/[licenses]" lines="1-37" reason="cargo-deny configuration - licenses allow-list, security advisories ignore list. Already configured." />
    </code>
    <dependencies>
      <rust>
        <package name="ratatui" version="0.29" purpose="Terminal UI framework" />
        <package name="crossterm" version="0.29" purpose="Cross-platform terminal I/O" />
        <package name="thiserror" version="2.0" purpose="Error handling derive macros" />
        <package name="tracing" version="0.1" purpose="Structured logging" />
        <package name="image" version="0.25" optional="true" feature="image" purpose="Image loading (PNG, JPG, etc.)" />
        <package name="imageproc" version="0.24" optional="true" feature="image" purpose="Image processing algorithms" />
        <package name="resvg" version="0.38" optional="true" feature="svg" purpose="SVG rasterization" />
        <package name="usvg" version="0.38" optional="true" feature="svg" purpose="SVG parsing" />
      </rust>
      <dev>
        <package name="criterion" version="0.7" purpose="Benchmarking framework" />
        <package name="tracing-subscriber" version="0.3" purpose="Log output for tests" />
        <package name="tempfile" version="3.10" purpose="Temporary file handling" />
        <package name="proptest" version="1.4" purpose="Property-based testing" />
      </dev>
      <tools>
        <tool name="cargo-audit" purpose="Security vulnerability scanning" />
        <tool name="cargo-deny" purpose="License and dependency checks" />
        <tool name="cargo-tarpaulin" purpose="Code coverage reporting" />
      </tools>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="licensing">Crate must be dual-licensed MIT OR Apache-2.0 (already configured)</constraint>
    <constraint type="msrv">Minimum Supported Rust Version is 1.70 (already configured)</constraint>
    <constraint type="dependencies">All dependencies must use permissive licenses (MIT, Apache-2.0, BSD, ISC, Zlib)</constraint>
    <constraint type="security">No known security advisories (cargo audit must pass; RUSTSEC-2024-0436 ignored for paste crate)</constraint>
    <constraint type="size">Package size must be reasonable (&lt;10MB for full crate with all features)</constraint>
    <constraint type="binary">Binary size impact &lt;2MB for core library</constraint>
    <constraint type="semver">Version 0.1.0 allows breaking changes; post-1.0 requires strict semver</constraint>
    <constraint type="stability">No breaking changes after publication in 0.1.x patch releases</constraint>
    <constraint type="ci">Release workflow must pass full test suite, clippy, and docs build before publishing</constraint>
  </constraints>

  <interfaces>
    <interface name="crates.io Registry" kind="external-service">
      <signature>cargo publish --token $CARGO_REGISTRY_TOKEN</signature>
      <path>Cargo.toml manifest</path>
      <notes>Requires CARGO_REGISTRY_TOKEN secret in GitHub repository settings</notes>
    </interface>
    <interface name="docs.rs Documentation" kind="external-service">
      <signature>Automatic build triggered by crates.io publication</signature>
      <path>src/**/*.rs with rustdoc comments</path>
      <notes>All features will be documented; may need docs.rs metadata in Cargo.toml</notes>
    </interface>
    <interface name="GitHub Releases" kind="external-service">
      <signature>softprops/action-gh-release action</signature>
      <path>.github/workflows/release.yml</path>
      <notes>Creates release page with notes from CHANGELOG.md</notes>
    </interface>
    <interface name="cargo publish --dry-run" kind="cli-tool">
      <signature>cargo publish --dry-run</signature>
      <path>Cargo.toml</path>
      <notes>Validates package can be published without actually publishing</notes>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing follows Rust conventions with comprehensive coverage. Unit tests use #[cfg(test)] mod tests within each source file. Integration tests in tests/ directory validate cross-module behavior. Property-based tests with proptest validate mathematical correctness. Benchmarks with Criterion measure performance targets. CI enforces all tests pass on stable Rust and MSRV 1.70 across Windows, Linux, and macOS. Coverage reporting via cargo-tarpaulin with target >70% overall.
    </standards>
    <locations>
      <location>src/**/*.rs (unit tests in #[cfg(test)] modules)</location>
      <location>tests/*.rs (integration tests)</location>
      <location>tests/property_tests.rs (property-based tests with proptest)</location>
      <location>tests/visual_regression.rs (visual regression tests)</location>
      <location>benches/*.rs (performance benchmarks)</location>
      <location>examples/*.rs (runnable examples, also tested by CI)</location>
    </locations>
    <ideas>
      <idea ac="AC1">Run full pre-publication checklist and document results in story</idea>
      <idea ac="AC4">Verify cargo publish --dry-run lists expected files and package size</idea>
      <idea ac="AC5">Test release workflow by creating test tag on feature branch first</idea>
      <idea ac="AC6">After publication, verify crate appears on crates.io within 10 minutes</idea>
      <idea ac="AC8">After publication, verify docs.rs builds within 30 minutes</idea>
      <idea ac="AC9">Create fresh project, run cargo add dotmax, test hello_braille example</idea>
      <idea ac="AC9">Test feature flag combinations: default, image, svg, image+svg</idea>
    </ideas>
  </tests>
</story-context>
