<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>5</storyId>
    <title>Add Color Support for Drawing Primitives</title>
    <status>drafted</status>
    <generatedAt>2025-11-23</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>/mnt/e/dotmax/docs/sprint-artifacts/4-5-add-color-support-for-drawing-primitives.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer creating colored graphics</asA>
    <iWant>to set colors for line/circle/shape drawing</iWant>
    <soThat>programmatic graphics can be vibrant and visually rich</soThat>
    <tasks>
- Task 1: Review Epic 2 Color API (AC: #4, #7)
- Task 2: Implement Colored Line Drawing (AC: #1)
- Task 3: Implement Colored Circle Drawing (AC: #2)
- Task 4: Implement Colored Rectangle Drawing (AC: #3)
- Task 5: Implement Colored Polygon Drawing (AC: #3)
- Task 6: Add Comprehensive Unit Tests (AC: #8)
- Task 7: Create Colored Shapes Example (AC: #6)
- Task 8: Integration Testing (AC: #7, #8)
- Task 9: Documentation and Finalization (AC: #9)
    </tasks>
  </story>

  <acceptanceCriteria>
AC1: Colored Line Drawing - Extend draw_line/draw_line_thick to support color parameter via draw_line_colored function
AC2: Colored Circle Drawing - Extend draw_circle/draw_filled_circle to support color parameter via draw_circle_colored function
AC3: Colored Rectangle and Shape Drawing - Extend draw_rectangle/draw_polygon to support color parameter via colored variants
AC4: Internal Color Handling - Drawing primitives call BrailleGrid::set_dot_with_color or equivalent API from Story 2.6
AC5: Backward Compatibility - All existing non-colored primitive functions remain unchanged with no breaking changes
AC6: Color Examples - Create examples/colored_shapes.rs demonstrating colored primitives (red circle, green rectangle, blue line, yellow polygon)
AC7: Integration with Epic 2 Color System - Use Color type from Epic 2, verify color rendering works with TerminalRenderer
AC8: Comprehensive Testing - Unit tests achieve >80% coverage for colored primitive functions
AC9: Production-Quality Documentation - Rustdoc on all colored primitive functions with examples and prerequisites documented
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-4.md</path>
        <title>Epic 4 Technical Specification: Drawing Primitives & Density Rendering</title>
        <section>Epic-Level Acceptance Criteria, APIs and Interfaces</section>
        <snippet>Epic 4 introduces geometric drawing primitives and character density-based rendering. AC7 mentions forward-compatibility with Epic 5 color system via DrawConfig Option&lt;Color&gt; field. Story 4.5 adds colored variants of primitives with _colored suffix.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>dotmax Architecture Document</title>
        <section>Module Structure, Decision Summary, Color System Integration</section>
        <snippet>Architecture defines src/primitives.rs for Bresenham line/circle/rectangle/polygon drawing. src/color.rs provides Color type. Epic 5 color system will provide comprehensive color schemes. Story 4.5 bridges primitives and color system.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/sprint-status.yaml</path>
        <title>Sprint Status</title>
        <section>Story 2.6, Story 4.1-4.4 Status</section>
        <snippet>Story 2.6 (implement-color-support-for-braille-cells) is DONE - provides Color struct and set_cell_color API. Stories 4.1-4.4 are DONE providing line, circle, rectangle, polygon, and density rendering. Story 4.5 adds color support to these primitives.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/grid.rs</path>
        <kind>module</kind>
        <symbol>Color, BrailleGrid::set_cell_color</symbol>
        <lines>32-62, 775-801</lines>
        <reason>Color struct (rgb, black, white constructors) and set_cell_color method are the core APIs for Story 4.5. Color is stored per-cell. Need to convert dot coordinates to cell coordinates (cell_x = x/2, cell_y = y/4).</reason>
      </artifact>
      <artifact>
        <path>src/primitives/line.rs</path>
        <kind>module</kind>
        <symbol>draw_line</symbol>
        <lines>92-98</lines>
        <reason>Existing line drawing function using Bresenham algorithm. Story 4.5 will add draw_line_colored variant that calls set_cell_color for each dot.</reason>
      </artifact>
      <artifact>
        <path>src/primitives/circle.rs</path>
        <kind>module</kind>
        <symbol>draw_circle, draw_filled_circle</symbol>
        <lines>67-99, 120-180</lines>
        <reason>Existing circle drawing functions (outline and filled). Story 4.5 will add draw_circle_colored variant with color parameter.</reason>
      </artifact>
      <artifact>
        <path>src/primitives/shapes.rs</path>
        <kind>module</kind>
        <symbol>draw_rectangle, draw_filled_rectangle, draw_polygon</symbol>
        <lines>79-115, 130-180, 200-250</lines>
        <reason>Existing rectangle and polygon drawing functions. Story 4.5 will add draw_rectangle_colored and draw_polygon_colored variants.</reason>
      </artifact>
      <artifact>
        <path>src/error.rs</path>
        <kind>module</kind>
        <symbol>DotmaxError</symbol>
        <lines>1-50</lines>
        <reason>Error types for all operations. Story 4.5 will use existing error types (OutOfBounds, InvalidDimensions) for colored primitives.</reason>
      </artifact>
    </code>
    <dependencies>
      <rust>
        <core>ratatui = "0.29", crossterm = "0.29", thiserror = "2.0", tracing = "0.1"</core>
        <optional>image = "0.25", imageproc = "0.24", resvg = "0.38", usvg = "0.38"</optional>
        <dev>criterion = "0.7", tracing-subscriber = "0.3"</dev>
      </rust>
    </dependencies>
  </artifacts>

  <constraints>
- **Zero panics policy**: All colored primitive functions must validate inputs and return Result types. Out-of-bounds coordinates, invalid dimensions must return typed errors.
- **Backward compatibility**: All existing non-colored primitive functions (draw_line, draw_circle, draw_rectangle, draw_polygon) must remain unchanged. No breaking changes to Epic 4 Stories 4.1-4.3 APIs.
- **Additive API design**: Colored functions use _colored suffix (draw_line_colored, draw_circle_colored, etc.). Existing functions continue to work.
- **Color mode prerequisite**: Colored primitives require BrailleGrid with color support enabled (grid.enable_color_support()). Document this requirement in rustdoc.
- **Dot-to-cell coordinate conversion**: Color is stored per-cell (not per-dot). Convert dot coordinates to cell coordinates: cell_x = x/2, cell_y = y/4.
- **Performance targets**: Colored primitives should have <1ms overhead vs non-colored (color setting is O(1) per dot). No new algorithms, just add color parameter to set_dot calls.
- **Testing standards**: >80% code coverage (Epic 4 standard), unit tests for all colored functions, integration tests with Epic 2 color system.
- **Documentation standards**: Rustdoc on all colored functions with examples, document color prerequisites, note backward compatibility guarantees.
  </constraints>
  <interfaces>
    <interface>
      <name>BrailleGrid::set_cell_color</name>
      <kind>method</kind>
      <signature>pub fn set_cell_color(&amp;mut self, x: usize, y: usize, color: Color) -&gt; Result&lt;(), DotmaxError&gt;</signature>
      <path>src/grid.rs:775-801</path>
      <usage>Called by colored primitive functions to set color for each dot. Requires converting dot coordinates to cell coordinates first.</usage>
    </interface>
    <interface>
      <name>Color::rgb</name>
      <kind>constructor</kind>
      <signature>pub const fn rgb(r: u8, g: u8, b: u8) -&gt; Self</signature>
      <path>src/grid.rs:43-45</path>
      <usage>Constructor for creating Color values. Used in examples and tests to create colored shapes (e.g., Color::rgb(255, 0, 0) for red).</usage>
    </interface>
    <interface>
      <name>draw_line</name>
      <kind>function</kind>
      <signature>pub fn draw_line(grid: &amp;mut BrailleGrid, x0: i32, y0: i32, x1: i32, y1: i32) -&gt; Result&lt;(), DotmaxError&gt;</signature>
      <path>src/primitives/line.rs:92-98</path>
      <usage>Existing line drawing function. Story 4.5 will add draw_line_colored variant that accepts Color parameter and calls set_cell_color for each dot.</usage>
    </interface>
    <interface>
      <name>draw_circle</name>
      <kind>function</kind>
      <signature>pub fn draw_circle(grid: &amp;mut BrailleGrid, center_x: i32, center_y: i32, radius: u32) -&gt; Result&lt;(), DotmaxError&gt;</signature>
      <path>src/primitives/circle.rs:67-99</path>
      <usage>Existing circle drawing function. Story 4.5 will add draw_circle_colored variant with color parameter.</usage>
    </interface>
    <interface>
      <name>draw_rectangle</name>
      <kind>function</kind>
      <signature>pub fn draw_rectangle(grid: &amp;mut BrailleGrid, x: i32, y: i32, width: u32, height: u32) -&gt; Result&lt;(), DotmaxError&gt;</signature>
      <path>src/primitives/shapes.rs:79-115</path>
      <usage>Existing rectangle drawing function. Story 4.5 will add draw_rectangle_colored variant with color parameter and filled parameter.</usage>
    </interface>
  </interfaces>
  <tests>
    <standards>
Epic 4 testing standards: >80% code coverage (matching Epic 3 quality standard). Unit tests in #[cfg(test)] modules within source files (src/primitives/line.rs, circle.rs, shapes.rs). Integration tests in tests/ directory. All tests use cargo test --all-features. Zero clippy warnings enforced. Criterion benchmarks for performance validation (target <1ms for typical shapes). Visual validation via examples (examples/ directory). Test across all platforms (Linux, macOS, Windows) in CI pipeline.
    </standards>
    <locations>
- **Unit tests**: src/primitives/line.rs (mod tests), src/primitives/circle.rs (mod tests), src/primitives/shapes.rs (mod tests)
- **Integration tests**: tests/integration_tests.rs, tests/image_rendering_tests.rs, tests/density_integration_tests.rs (or create tests/color_primitives_integration_tests.rs)
- **Examples**: examples/colored_shapes.rs (to be created), examples/lines_demo.rs, examples/circles_demo.rs, examples/shapes_demo.rs
- **Benchmarks**: benches/primitives.rs (if exists, or create)
    </locations>
    <ideas>
- **AC1 (Colored Line Drawing)**: Test draw_line_colored with various colors, verify grid.get_color returns expected color at line coordinates. Test horizontal, vertical, diagonal lines. Test thick lines with color.
- **AC2 (Colored Circle Drawing)**: Test draw_circle_colored with color parameter, verify color on circle perimeter dots. Test filled circles with color (all interior dots have same color).
- **AC3 (Colored Rectangle/Polygon)**: Test draw_rectangle_colored (outline and filled) with color. Test draw_polygon_colored with triangle, square, pentagon. Verify color on all edges/fill.
- **AC4 (Internal Color Handling)**: Test that colored primitives correctly convert dot coordinates to cell coordinates (cell_x = x/2, cell_y = y/4). Verify set_cell_color is called with correct cell coordinates.
- **AC5 (Backward Compatibility)**: Test that existing non-colored functions (draw_line, draw_circle, draw_rectangle, draw_polygon) still work without modification. No breaking changes.
- **AC6 (Color Examples)**: Visual validation via examples/colored_shapes.rs - draw red circle, green rectangle, blue line, yellow polygon. Verify colors render correctly on terminal (manual inspection).
- **AC7 (Epic 2 Integration)**: Integration test: create color-enabled grid (grid.enable_color_support()), draw colored shapes, render to terminal, verify colored output appears.
- **AC8 (Comprehensive Testing)**: Unit test coverage >80%, test each colored primitive function, test color application, test backward compatibility, integration test with multiple colored shapes on same grid.
- **AC9 (Documentation)**: Manual review - cargo doc --open, verify rustdoc quality, verify examples compile and run, verify prerequisites documented.
    </ideas>
  </tests>
</story-context>
