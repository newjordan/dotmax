<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>3</storyId>
    <title>Define Core Dependencies with Feature Flags</title>
    <status>drafted</status>
    <generatedAt>2025-11-17</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-3-define-core-dependencies-with-feature-flags.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer building with dotmax</asA>
    <iWant>core dependencies to be minimal (<10 total) with optional features behind feature flags</iWant>
    <soThat>my binary size stays under 2MB for the core library while enabling opt-in capabilities (image, SVG) when needed</soThat>
    <tasks>- Task 1: Add core dependencies to Cargo.toml (AC: #1, #9)
  - Add ratatui = "0.29" to [dependencies]
  - Add crossterm = "0.29" to [dependencies]
  - Add thiserror = "2.0" to [dependencies]
  - Add tracing = "0.1" to [dependencies]
  - Verify exactly 4 core dependencies (no more, no less)

- Task 2: Add optional dependencies with feature gates (AC: #2, #9)
  - Add image = { version = "0.25", optional = true } to [dependencies]
  - Add imageproc = { version = "0.24", optional = true } to [dependencies]
  - Add resvg = { version = "0.38", optional = true } to [dependencies]
  - Add usvg = { version = "0.38", optional = true } to [dependencies]
  - Verify optional = true is set for all non-core dependencies

- Task 3: Define feature flags (AC: #3)
  - Add [features] section to Cargo.toml
  - Define default = [] (no features enabled by default)
  - Define image = ["dep:image", "dep:imageproc"] feature
  - Define svg = ["dep:resvg", "dep:usvg"] feature
  - Verify feature syntax uses weak dependency features (dep:)

- Task 4: Add dev dependencies (AC: #9)
  - Add criterion = { version = "0.7", features = ["html_reports"] } to [dev-dependencies]
  - Add tracing-subscriber = "0.3" to [dev-dependencies]
  - Verify dev dependencies are separate from main dependencies

- Task 5: Test core-only build (AC: #4, #8)
- Task 6: Test feature-gated builds (AC: #5, #6, #7)
- Task 7: Validate CI with new dependencies (AC: #10)
- Task 8: Document dependency justifications (AC: #9, implied)</tasks>
  </story>

  <acceptanceCriteria>1. Cargo.toml defines exactly 4 core dependencies (always included): ratatui, crossterm, thiserror, tracing
2. Optional dependencies are feature-gated: image, imageproc behind image feature; resvg, usvg behind svg feature
3. [features] section defines: default = [], image = ["dep:image", "dep:imageproc"], svg = ["dep:resvg", "dep:usvg"]
4. cargo build (no features) compiles successfully with only 4 core dependencies
5. cargo build --features image adds image/imageproc dependencies
6. cargo build --features svg adds resvg/usvg dependencies
7. cargo build --features image,svg includes all optional dependencies
8. Binary size for core-only build is <2MB (measured with cargo build --release)
9. Dependency versions match Architecture Document specifications (ratatui 0.29, crossterm 0.29, thiserror 2.0, tracing 0.1, image 0.25, imageproc 0.24, resvg 0.38, usvg 0.38)
10. CI pipeline (from Story 1.2) passes for all feature combinations</acceptanceCriteria>

  <artifacts>
    <docs><!-- PRD - Dependency Requirements -->
<doc>
  <path>docs/PRD.md</path>
  <title>Product Requirements Document</title>
  <section>NFR-D1: Minimal Core Dependencies</section>
  <snippet>Core library must have less than 10 direct dependencies. Each dependency justified and documented. Prefer std library over external crates where reasonable.</snippet>
</doc>

<doc>
  <path>docs/PRD.md</path>
  <title>Product Requirements Document</title>
  <section>NFR-D3: Feature Flag Discipline</section>
  <snippet>Core rendering has zero optional dependencies. Image support: opt-in via `image` feature flag. Video support: opt-in via `video` feature flag (Phase 2). Raytrace support: opt-in via `raytrace` feature flag (Phase 3).</snippet>
</doc>

<doc>
  <path>docs/PRD.md</path>
  <title>Product Requirements Document</title>
  <section>NFR-P6: Binary Size Impact</section>
  <snippet>Core library adds less than 2MB to compiled binary size. Feature flags minimize bloat (opt-in for image/video/raytrace). Link-time optimization (LTO) compatible.</snippet>
</doc>

<!-- Architecture - Technology Stack -->
<doc>
  <path>docs/architecture.md</path>
  <title>Architecture Document</title>
  <section>Technology Stack Details - Core Dependencies</section>
  <snippet>Core dependencies (always included): ratatui = "0.29" (Terminal UI framework), crossterm = "0.29" (Cross-platform terminal I/O), thiserror = "2.0" (Error handling derive macros), tracing = "0.1" (Structured logging)</snippet>
</doc>

<doc>
  <path>docs/architecture.md</path>
  <title>Architecture Document</title>
  <section>Technology Stack Details - Optional Dependencies</section>
  <snippet>Optional dependencies (feature-gated): image = { version = "0.25", optional = true }, imageproc = { version = "0.24", optional = true }, resvg = { version = "0.38", optional = true }, usvg = { version = "0.38", optional = true }. Features: default = [], image = ["dep:image", "dep:imageproc"], svg = ["dep:resvg", "dep:usvg"]</snippet>
</doc>

<!-- Architecture - ADR 0003 -->
<doc>
  <path>docs/architecture.md</path>
  <title>Architecture Document</title>
  <section>ADR 0003: Feature Flag Architecture</section>
  <snippet>Decision: Use Cargo feature flags for optional capabilities. Core has zero optional dependencies. Image/SVG/video/3D are opt-in. Consequences: Core library stays minimal (<2MB binary size), users only pay for what they use, easier to add new features without bloating core.</snippet>
</doc>

<!-- Story 1.2 CI Context -->
<doc>
  <path>docs/sprint-artifacts/1-2-configure-github-actions-cicd-pipeline.md</path>
  <title>Story 1.2: Configure GitHub Actions CI/CD Pipeline</title>
  <section>Dev Notes</section>
  <snippet>CI infrastructure available: Cross-platform testing (Windows, Linux, macOS), Caching enabled (Swatinem/rust-cache@v2), Security scanning (cargo-audit), Multiple toolchains (Stable + MSRV 1.70). MSRV 1.70 constraint must be maintained for all dependencies.</snippet>
</doc></docs>
    <code><!-- Cargo.toml - Current State -->
<file>
  <path>Cargo.toml</path>
  <kind>manifest</kind>
  <symbol>[package]</symbol>
  <lines>1-11</lines>
  <reason>Current package manifest showing existing configuration. Currently has NO dependencies section - this story adds all core and optional dependencies.</reason>
</file>

<!-- lib.rs - Entry Point -->
<file>
  <path>src/lib.rs</path>
  <kind>library</kind>
  <symbol>lib module</symbol>
  <lines>1-24</lines>
  <reason>Main library entry point. Contains basic test to validate CI. Epic 2+ will add module structure. This story's dependencies will be used by future modules.</reason>
</file></code>
    <dependencies><!-- Dependency manifest detection -->
<ecosystem name="rust">
  <package>ratatui</package>
  <version>0.29</version>
  <status>to-be-added</status>
  <purpose>Terminal UI framework - Industry standard for Rust TUIs</purpose>
</ecosystem>

<ecosystem name="rust">
  <package>crossterm</package>
  <version>0.29</version>
  <status>to-be-added</status>
  <purpose>Cross-platform terminal I/O - Works with ratatui as backend</purpose>
</ecosystem>

<ecosystem name="rust">
  <package>thiserror</package>
  <version>2.0</version>
  <status>to-be-added</status>
  <purpose>Error handling derive macros - Minimal boilerplate for typed errors</purpose>
</ecosystem>

<ecosystem name="rust">
  <package>tracing</package>
  <version>0.1</version>
  <status>to-be-added</status>
  <purpose>Structured logging - Standard for Rust, instrument functions, multiple log levels</purpose>
</ecosystem>

<ecosystem name="rust">
  <package>image</package>
  <version>0.25</version>
  <status>to-be-added</status>
  <feature-gated>image</feature-gated>
  <optional>true</optional>
  <purpose>Standard Rust image library - Handles PNG/JPG/GIF/BMP/WebP/TIFF</purpose>
</ecosystem>

<ecosystem name="rust">
  <package>imageproc</package>
  <version>0.24</version>
  <status>to-be-added</status>
  <feature-gated>image</feature-gated>
  <optional>true</optional>
  <purpose>Image processing - Dithering algorithms, thresholding for Epic 3</purpose>
</ecosystem>

<ecosystem name="rust">
  <package>resvg</package>
  <version>0.38</version>
  <status>to-be-added</status>
  <feature-gated>svg</feature-gated>
  <optional>true</optional>
  <purpose>SVG rasterization to bitmap for Epic 3 vector graphics support</purpose>
</ecosystem>

<ecosystem name="rust">
  <package>usvg</package>
  <version>0.38</version>
  <status>to-be-added</status>
  <feature-gated>svg</feature-gated>
  <optional>true</optional>
  <purpose>SVG parsing - Required by resvg for SVG handling</purpose>
</ecosystem>

<ecosystem name="rust">
  <package>criterion</package>
  <version>0.7</version>
  <status>to-be-added</status>
  <dev-dependency>true</dev-dependency>
  <features>["html_reports"]</features>
  <purpose>Statistics-driven benchmarking with HTML reports for Story 1.6</purpose>
</ecosystem>

<ecosystem name="rust">
  <package>tracing-subscriber</package>
  <version>0.3</version>
  <status>to-be-added</status>
  <dev-dependency>true</dev-dependency>
  <purpose>Logging in tests and examples</purpose>
</ecosystem></dependencies>
  </artifacts>

  <constraints><!-- Development Constraints from Architecture and PRD -->

**1. MSRV Compatibility (Rust 1.70)**
- All dependencies MUST support Rust 1.70 or newer
- Verify each dependency's rust-version field or docs.rs before adding
- CI enforces MSRV in separate job - will fail if dependencies require newer Rust
- Source: docs/architecture.md#Technology-Stack-Details, Story 1.2 CI configuration

**2. Minimal Core Dependencies (<10 direct dependencies)**
- Core must have EXACTLY 4 dependencies: ratatui, crossterm, thiserror, tracing
- Optional dependencies do NOT count toward core limit
- Dev dependencies do NOT count toward core limit
- Source: docs/PRD.md#NFR-D1, docs/architecture.md#Decision-Summary

**3. Feature Flag Architecture (ADR 0003)**
- Core has ZERO optional dependencies by default
- Use weak dependency features syntax: `dep:package_name` (Rust 2021 edition)
- Example: `image = ["dep:image", "dep:imageproc"]` not `image = ["image", "imageproc"]`
- Default feature set is empty: `default = []`
- Source: docs/architecture.md#ADR-0003-Feature-Flag-Architecture

**4. Version Pinning Strategy**
- Major version locked (allows patch/minor updates within major version)
- Example: `ratatui = "0.29"` allows 0.29.x but blocks 0.30.x
- Rationale: Semantic versioning in Rust, manual review for major updates via dependabot
- Source: docs/architecture.md#Dependencies-and-Integrations

**5. Binary Size Target (<2MB)**
- Core-only build must add <2MB to compiled binaries
- Measured with: `cargo build --release` → check target/release/libdotmax.rlib
- If over 2MB, investigate with `cargo tree` and `cargo bloat --release`
- Source: docs/PRD.md#NFR-P6, docs/architecture.md#Performance-Considerations

**6. License Compatibility**
- All dependencies must use permissive licenses (MIT, Apache-2.0, BSD)
- NO GPL/AGPL dependencies (incompatible with dual licensing)
- Verify licenses manually via docs.rs before adding
- Story 1.4 will enforce with cargo-deny
- Source: docs/architecture.md#Security-Architecture

**7. Security Scanning**
- cargo-audit runs in CI (configured in Story 1.2)
- New dependencies must have ZERO known vulnerabilities
- If audit fails, pin to secure version or find alternative
- Source: docs/architecture.md#Security-Architecture, Story 1.2

**8. Cross-Platform Compilation**
- All dependencies must compile on: Windows, Linux, macOS
- CI matrix tests all platforms (Story 1.2 infrastructure)
- Some deps have platform-specific code (e.g., crossterm) - this is acceptable
- Source: docs/architecture.md#Platform-Support

**9. Cargo.toml Structure Ordering**
- Section order: [package] → [dependencies] → [features] → [dev-dependencies]
- Within dependencies: Core first, then optional (alphabetical within groups)
- Comments documenting purpose of each dependency group
- Source: docs/architecture.md#Technology-Stack-Details</constraints>
  <interfaces><!-- No external interfaces for this story -->
<!-- This story only modifies Cargo.toml configuration -->
<!-- Future stories (Epic 2+) will define actual code interfaces -->

<!-- CI Integration (from Story 1.2) -->
<interface>
  <name>GitHub Actions CI/CD Pipeline</name>
  <kind>CI/CD Integration</kind>
  <signature>Triggers on: push to any branch, pull request. Jobs: test matrix (Windows/Linux/macOS × stable/MSRV), security audit, clippy, rustfmt</signature>
  <path>.github/workflows/ci.yml</path>
  <note>Story 1.2 configured CI that will automatically test new dependencies across all platforms and feature combinations. This story validates against that infrastructure.</note>
</interface>

<!-- Cargo Feature System -->
<interface>
  <name>Cargo Feature Flags</name>
  <kind>Build System Configuration</kind>
  <signature>[features]
default = []
image = ["dep:image", "dep:imageproc"]
svg = ["dep:resvg", "dep:usvg"]</signature>
  <path>Cargo.toml</path>
  <note>Rust's feature flag system enables opt-in dependencies. Users specify features at build time: `cargo build --features image,svg`</note>
</interface></interfaces>
  <tests>
    <standards>**Testing Strategy for Story 1.3:**

This story is primarily **configuration and validation** - not code implementation. Testing focuses on build validation and dependency verification.

**1. Build Testing (Manual & CI)**
- Test all feature combinations:
  - `cargo build` (core only)
  - `cargo build --features image`
  - `cargo build --features svg`
  - `cargo build --features image,svg`
- Verify builds succeed on all platforms (Windows, Linux, macOS)
- CI from Story 1.2 automates cross-platform testing

**2. Binary Size Validation (Manual)**
- Measure core-only release build size
- Target: <2MB for libdotmax.rlib or minimal example binary
- Tool: `ls -lh target/release/libdotmax.rlib` after `cargo build --release`

**3. Dependency Auditing (CI)**
- cargo-audit scans for known vulnerabilities
- Must pass with zero advisories
- CI job configured in Story 1.2

**4. MSRV Compatibility (CI)**
- Separate CI job tests with Rust 1.70
- Ensures all dependencies support MSRV
- Configured in Story 1.2

**5. Dependency Count Verification (Manual)**
- Count direct dependencies in Cargo.lock
- Core: exactly 4 (ratatui, crossterm, thiserror, tracing)
- Tool: `cargo tree` to inspect dependency graph

**Testing Framework:**
- No unit tests required (no code logic)
- No integration tests required (configuration only)
- Validation is via build system and CI infrastructure</standards>
    <locations><!-- No dedicated test files for this story -->
<!-- Testing is via build commands and CI validation -->

**Build Test Commands:**
```bash
# Core-only build
cargo clean && cargo build --release

# Feature-gated builds
cargo clean && cargo build --features image
cargo clean && cargo build --features svg
cargo clean && cargo build --features image,svg
```

**Validation Commands:**
```bash
# Dependency tree inspection
cargo tree

# Binary size check
ls -lh target/release/libdotmax.rlib

# Security audit
cargo audit

# Clippy linting
cargo clippy -- -D warnings
```

**CI Validation:**
- .github/workflows/ci.yml (from Story 1.2)
- Runs automatically on push
- Tests all platforms and feature combinations</locations>
    <ideas><!-- Test Ideas Mapped to Acceptance Criteria -->

**AC #1: Exactly 4 core dependencies**
- Test: Run `cargo tree --depth=1` and count direct dependencies
- Verify: ratatui, crossterm, thiserror, tracing appear exactly once
- Verify: No other dependencies listed at depth 1

**AC #2, #3: Feature-gated optional dependencies**
- Test: `cargo build` without features, inspect Cargo.lock
- Verify: image, imageproc, resvg, usvg do NOT appear
- Test: `cargo build --features image`, inspect Cargo.lock
- Verify: image, imageproc appear, but resvg/usvg do not
- Test: `cargo build --features svg`, inspect Cargo.lock
- Verify: resvg, usvg appear, but image/imageproc do not

**AC #4: Core-only build succeeds**
- Test: `cargo clean && cargo build --release`
- Verify: Build completes without errors
- Verify: Only 4 core dependencies in Cargo.lock (plus transitive)

**AC #5, #6, #7: Feature combination builds**
- Test matrix:
  - `cargo build --features image` → succeeds
  - `cargo build --features svg` → succeeds
  - `cargo build --features image,svg` → succeeds
- Verify: Each build completes successfully
- Verify: Correct dependencies appear in Cargo.lock for each

**AC #8: Binary size <2MB**
- Test: `cargo clean && cargo build --release`
- Measure: `ls -lh target/release/libdotmax.rlib`
- Verify: Size is under 2MB
- If over: Run `cargo bloat --release` to investigate

**AC #9: Dependency versions match Architecture**
- Test: Read Cargo.toml [dependencies] section
- Verify against docs/architecture.md#Technology-Stack-Details:
  - ratatui = "0.29" ✓
  - crossterm = "0.29" ✓
  - thiserror = "2.0" ✓
  - tracing = "0.1" ✓
  - image = "0.25" ✓
  - imageproc = "0.24" ✓
  - resvg = "0.38" ✓
  - usvg = "0.38" ✓

**AC #10: CI passes for all feature combinations**
- Test: Push changes to GitHub
- Monitor: GitHub Actions workflow from Story 1.2
- Verify: All matrix jobs pass:
  - Windows/Linux/macOS × stable/MSRV
  - cargo test (all feature combos)
  - cargo audit (no vulnerabilities)
  - cargo clippy (no warnings)
  - Build time <5 min with warm cache</ideas>
  </tests>
</story-context>
