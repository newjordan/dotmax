<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3.5</epicId>
    <storyId>3.5.3</storyId>
    <title>Add Otsu Threshold Toggle Control</title>
    <status>drafted</status>
    <generatedAt>2025-11-21</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/3-5-3-add-otsu-threshold-toggle-control.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user interactively adjusting image rendering</asA>
    <iWant>the ability to toggle between automatic Otsu thresholding and manual threshold values</iWant>
    <soThat>I can fine-tune image contrast for optimal braille output in different lighting scenarios</soThat>
    <tasks>
      - Task 1: Define Threshold Mode Types (AC: #3)
      - Task 2: Implement Threshold Mode Toggle Logic (AC: #1, #3)
      - Task 3: Implement Manual Threshold Adjustment (AC: #2, #7)
      - Task 4: Add Keyboard Controls to image_browser.rs (AC: #1)
      - Task 5: Integrate Threshold Mode with ImageRenderer (AC: #4)
      - Task 6: Update UI Display (AC: #5, #8)
      - Task 7: Manual Testing (AC: #9)
      - Task 8: Update Documentation (AC: #8)
      - Task 9: Code Quality Checks (AC: all)
    </tasks>
  </story>

  <acceptanceCriteria>
    1. **AC1: Add Threshold Toggle Control to Interactive Examples**
       - `image_browser.rs` example adds keyboard controls for threshold mode:
         - Press `O` (capital O) to toggle between Auto (Otsu) and Manual modes
         - Press `+` to increase manual threshold by 10 (range: 0-255)
         - Press `-` to decrease manual threshold by 10 (range: 0-255)
       - UI displays current threshold mode and value (e.g., "Threshold: Auto (Otsu)" or "Threshold: Manual (128)")
       - Default mode remains Auto (Otsu) for backward compatibility

    2. **AC2: Manual Threshold Value Control**
       - When in Manual mode, `+` and `-` keys adjust threshold value
       - Threshold value clamped to valid range [0, 255]
       - Value changes trigger immediate re-render with new threshold
       - Changes are smooth and responsive (&lt;200ms per re-render)

    3. **AC3: Threshold Mode State Management**
       - `RenderSettings` struct in `image_browser.rs` tracks:
         - `threshold_mode: ThresholdMode` enum (Auto vs Manual)
         - `manual_threshold_value: u8` (default: 128)
       - Toggle between modes preserves last manual threshold value
       - Switching to Auto mode ignores manual value, uses Otsu calculation
       - Switching back to Manual mode restores previous manual value

    4. **AC4: ImageRenderer API Integration**
       - `ImageRenderer` builder pattern already has `.threshold(u8)` method
       - Manual mode calls `.threshold(value)` before `.render()`
       - Auto mode omits `.threshold()` call, allowing Otsu to execute
       - No changes needed to ImageRenderer itself (API already supports both modes)

    5. **AC5: UI Feedback and Display**
       - Status footer shows current threshold mode clearly
       - Format examples: "Threshold: Auto (Otsu)", "Threshold: Manual (128)", "Threshold: Manual (200)"
       - UI updates immediately when mode or value changes
       - Help text in footer explains threshold controls

    6. **AC6: Reset Functionality**
       - Existing `R` (reset) key resets threshold to Auto (Otsu) mode
       - Reset also sets manual threshold value back to default (128)
       - Threshold reset included in RenderSettings::reset() implementation

    7. **AC7: Edge Cases and Validation**
       - Manual threshold value clamped to [0, 255] range
       - Value 0 = all pixels white (no dots)
       - Value 255 = all pixels black (all dots)
       - Threshold adjustments work correctly with all dithering modes
       - Threshold adjustments work correctly with all color modes

    8. **AC8: Documentation**
       - `image_browser.rs` comments explain threshold mode toggle
       - Example README.md updated with threshold control instructions
       - Help text in UI footer includes threshold controls: O (toggle Otsu/Manual), +/- (adjust manual threshold)
       - Known limitation documented: Threshold only affects binary conversion (not relevant for color sampling)

    9. **AC9: Testing and Validation**
       - Manual testing with `image_browser.rs`: Toggle between Auto and Manual modes works, Manual threshold adjustments visible in output
       - Otsu mode produces optimal contrast automatically, Reset (`R`) correctly resets threshold mode
       - Test with various image types (photos, line art, diagrams)
       - Verify threshold control works with all dithering methods
  </acceptanceCriteria>

  <artifacts>
    <docs></docs>
    <code></code>
    <dependencies></dependencies>
  </artifacts>

  <constraints></constraints>
  <interfaces></interfaces>
  <tests>
    <standards></standards>
    <locations></locations>
    <ideas></ideas>
  </tests>
</story-context>
