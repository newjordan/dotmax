<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3.5</epicId>
    <storyId>3.5.4</storyId>
    <title>Improve SVG Font Handling</title>
    <status>drafted</status>
    <generatedAt>2025-11-21</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/3-5-4-improve-svg-font-handling.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user rendering SVG images with text elements</asA>
    <iWant>improved font rendering quality for SVG text</iWant>
    <soThat>text-heavy SVGs (diagrams, logos with text) display clearly and legibly in braille output</soThat>
    <tasks>
- Task 1: Research Phase - Root Cause Analysis (AC: #1)
  - 1.1: Review Story 3.9 manual testing notes for font quality complaints
  - 1.2: Load test SVG with text in current implementation (Story 3.6 code)
  - 1.3: Inspect resvg/fontdb source code and documentation
  - 1.4: Test font rendering on Linux/WSL (primary platform)
  - 1.5: Check if fonts are available in /usr/share/fonts or system font paths
  - 1.6: Enable debug logging for resvg font loading (if available)
  - 1.7: Document root cause: missing fonts, poor fallback, or rasterization issue
  - 1.8: Determine if fixable within dotmax or external limitation

- Task 2: Create Font Test SVG Assets (AC: #3)
  - 2.1: Create directory tests/test_assets/svg_font_tests/
  - 2.2: Create simple_text.svg with Arial/Helvetica text element
  - 2.3: Create mixed_fonts.svg with multiple font families
  - 2.4: Create small_text.svg with various small font sizes
  - 2.5: Create fallback_font.svg with uncommon font family
  - 2.6: Create bold_italic.svg with font weight and style variations
  - 2.7: Validate SVGs render correctly in browser or SVG viewer

- Task 3: Evaluate resvg Font Configuration (AC: #2)
  - 3.1: Review resvg documentation for fontdb configuration
  - 3.2: Experiment with fontdb::Database configuration options
  - 3.3: Test explicit font loading from system paths
  - 3.4: Test font family preferences and fallback chains
  - 3.5: Measure quality improvements for each configuration
  - 3.6: Document which options are practical for dotmax

- Task 4: Implement Font Improvements (if fixable) (AC: #4)
  - 4.1: Modify src/image/svg.rs based on research findings
  - 4.2: Configure fontdb to load system fonts explicitly (if needed)
  - 4.3: Adjust font rendering hints or rasterization parameters
  - 4.4: Test improvements with font test SVGs from Task 2
  - 4.5: Verify no performance regression (<10ms overhead)
  - 4.6: Run full test suite to ensure no breakage
  - 4.7: Verify zero panics guarantee maintained

- Task 5: Add Font Configuration API (optional) (AC: #5)
  - 5.1: Determine if user configuration is necessary
  - 5.2: Design SvgOptions struct or builder pattern (if needed)
  - 5.3: Add font directory or font family configuration options
  - 5.4: Implement load_svg_with_options() function variant
  - 5.5: Maintain backward compatibility (default behavior unchanged)
  - 5.6: Add unit tests for new API (if implemented)
  - 5.7: Update rustdoc with new API examples

- Task 6: Update Documentation (AC: #6)
  - 6.1: Add "Font Handling" section to src/image/svg.rs rustdoc
  - 6.2: Explain resvg/fontdb font loading mechanism
  - 6.3: Document platform-specific font behavior
  - 6.4: Document limitations (if fonts remain imperfect)
  - 6.5: Provide best practices and recommendations for users
  - 6.6: Document any new font configuration APIs
  - 6.7: Update examples with font-related comments

- Task 7: Create Font Quality Example (AC: #7)
  - 7.1: Create examples/svg_font_quality.rs or update svg_demo.rs
  - 7.2: Load SVGs from tests/test_assets/svg_font_tests/
  - 7.3: Demonstrate best practices for text rendering
  - 7.4: Add inline comments explaining font quality considerations
  - 7.5: Verify example compiles: cargo build --example svg_font_quality --features svg,image
  - 7.6: Verify example runs successfully: cargo run --example svg_font_quality --features svg,image

- Task 8: Add Integration Tests (AC: #8)
  - 8.1: Add test functions to tests/image_rendering_tests.rs
  - 8.2: Test simple_text.svg renders without panic
  - 8.3: Test fallback_font.svg uses fallback successfully
  - 8.4: Test small_text.svg renders legibly
  - 8.5: Verify text elements are visible in output (not blank)
  - 8.6: Verify text distinguishable from background
  - 8.7: Run integration tests: cargo test --features svg,image --test image_rendering_tests

- Task 9: Manual Validation (AC: #9)
  - 9.1: Test font rendering with real SVG files (diagrams, logos)
  - 9.2: Compare before vs after improvements (if implemented)
  - 9.3: Capture terminal output or screenshots for comparison
  - 9.4: Test on Linux/WSL (primary platform)
  - 9.5: Test on Windows or macOS if available
  - 9.6: Document subjective quality assessment
  - 9.7: Document findings in Dev Agent Record → Completion Notes
  - 9.8: If no improvement: document clearly and recommend workarounds

- Task 10: Code Quality and Cleanup (AC: all)
  - 10.1: Run clippy: cargo clippy --features svg,image -- -D warnings
  - 10.2: Fix any clippy warnings introduced
  - 10.3: Run rustfmt: cargo fmt
  - 10.4: Verify full test suite passes: cargo test --features svg,image
  - 10.5: Verify benchmarks still compile: cargo bench --features svg --no-run
  - 10.6: Update CHANGELOG.md with font improvements (if applicable)
    </tasks>
  </story>

  <acceptanceCriteria>
AC1: Research SVG Font Rendering Issues
- Investigate why current SVG text rendering quality is poor ("kinda sucks" per Story 3.9)
- Identify root cause: missing fonts, fontdb fallback issues, anti-aliasing problems, or resolution mismatch
- Document findings with evidence (screenshots, logs, test cases)
- Determine if fixable within dotmax scope or external limitation

AC2: Evaluate resvg Font Configuration Options
- Review resvg documentation for font configuration APIs
- Test fontdb configuration options (system font loading, font family preferences, rendering options)
- Experiment with different font sources (system fonts, embedded fonts, explicit loading)
- Document which options improve quality measurably

AC3: Create Font Test SVG Suite
- Create tests/test_assets/svg_font_tests/ directory
- Add 5 test SVGs: simple_text.svg, mixed_fonts.svg, small_text.svg, fallback_font.svg, bold_italic.svg
- Each SVG has clear expected rendering
- Include in integration tests for regression detection

AC4: Implement Font Quality Improvements (if fixable)
- Based on research, implement improvements to src/image/svg.rs
- Maintain zero panics guarantee, no breakage to existing SVG rendering
- Performance impact <10ms overhead
- Full test suite passes

AC5: Add Font Configuration API (optional)
- If user configuration beneficial: add SvgOptions struct or builder pattern
- Allow specifying font directories or families
- Keep default behavior unchanged (backward compatibility)
- Skip if improvements work automatically

AC6: Document Font Handling Behavior
- Update rustdoc in src/image/svg.rs with font handling section
- Explain resvg/fontdb font loading and fallback behavior
- Document platform-specific font behavior
- Document limitations and workarounds if fonts remain imperfect
- Provide recommendations for best braille rendering

AC7: Create Font Quality Example
- Add examples/svg_font_quality.rs (or update existing svg_demo.rs)
- Demonstrate best practices for SVG text rendering
- Load test SVGs from tests/test_assets/svg_font_tests/
- Include explanatory comments
- Example runs successfully with svg,image features

AC8: Integration Testing for Font Rendering
- Add integration tests in tests/image_rendering_tests.rs
- Test font test SVGs render without panic
- Test fallback fonts work when specified font missing
- Verify text elements visible and distinguishable from background
- Tests pass on CI (Linux environment)

AC9: Manual Validation and Comparison
- Manually test font rendering improvements with real SVG files
- Before/after comparison with terminal output or screenshots
- Measure subjective quality improvement
- Test on multiple platforms if possible
- Document findings in Dev Agent Record → Completion Notes
- If no improvement: document why and recommend workarounds
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <!-- Architecture document -->
      <doc path="docs/architecture.md" title="dotmax Architecture" section="ADR 0001: Use Unicode Braille"
           snippet="Universal compatibility via Unicode braille (U+2800-U+28FF), 2×4 dot matrix per cell" />

      <!-- Tech spec for Epic 3 -->
      <doc path="docs/sprint-artifacts/tech-spec-epic-3.md" title="Epic 3 Technical Specification" section="SVG Rendering Approach"
           snippet="SVGs rasterized via usvg/resvg with automatic brightness inversion for dark backgrounds. Font handling via fontdb with automatic fallback." />

      <!-- Epic 3 retrospective - font issue origin -->
      <doc path="docs/sprint-artifacts/epic-3-retro-2025-11-21.md" title="Epic 3 Retrospective" section="Story 3.5.4: Improve SVG Font Handling"
           snippet="Issue: SVG text rendering 'kinda sucks' per Story 3.9 manual testing. Research phase needed to identify if missing fonts, poor fallback, or resvg limitation." />

      <!-- Story 3.6 - base SVG implementation -->
      <doc path="docs/sprint-artifacts/3-6-add-svg-vector-graphics-support-with-rasterization.md" title="Story 3.6: SVG Support" section="Font Handling"
           snippet="resvg uses system fonts via fontdb. Missing fonts use fallback system fonts (don't fail). Document requirement: 'System fonts needed for text-heavy SVGs'" />
    </docs>

    <code>
      <!-- Current SVG implementation -->
      <artifact path="src/image/svg.rs" kind="module" symbol="load_svg_from_path, load_svg_from_bytes, rasterize_svg_tree" lines="1-548"
                reason="Core SVG rasterization implementation. Current uses default fontdb (no explicit configuration). Research will focus on improving font handling here." />

      <artifact path="src/image/svg.rs" kind="documentation" symbol="module rustdoc" lines="1-120"
                reason="Current font handling documentation at lines 53-58: 'SVGs with text require system fonts. resvg uses fontdb to locate fonts automatically. Missing fonts fall back to generic sans-serif.'" />

      <artifact path="src/image/svg.rs" kind="function" symbol="rasterize_svg_tree" lines="318-407"
                reason="Rasterization function that would be modified to configure fontdb explicitly if research shows improvement." />

      <!-- SVG module re-exports -->
      <artifact path="src/image/mod.rs" kind="module" symbol="svg module re-export" lines="121-133"
                reason="Public API surface for SVG functions. If SvgOptions API added (AC5), would update here." />

      <!-- Error types for SVG -->
      <artifact path="src/error.rs" kind="enum" symbol="DotmaxError::SvgError" lines="1-100"
                reason="SVG-specific error variant. May add font-specific error variants if new font configuration added." />

      <!-- Existing SVG examples -->
      <artifact path="examples/svg_demo.rs" kind="example" symbol="main" lines="all"
                reason="Existing SVG example. May update this or create new svg_font_quality.rs per AC7." />

      <artifact path="examples/test_svg_loading.rs" kind="example" symbol="main" lines="all"
                reason="SVG loading test example. Reference for creating font quality example." />

      <!-- Integration tests -->
      <artifact path="tests/image_rendering_tests.rs" kind="test" symbol="SVG integration tests" lines="all"
                reason="Existing SVG integration tests. Will add font-specific tests per AC8." />
    </code>

    <dependencies>
      <rust>
        <core>
          <dep name="resvg" version="0.38" reason="SVG rasterization engine (MPL-2.0 license). Provides render() function for converting SVG trees to pixel buffers." />
          <dep name="usvg" version="0.38" reason="SVG parsing and normalization (MPL-2.0 license). Parses SVG XML into tree structure, handles viewBox, text elements." />
        </core>
        <transitive>
          <dep name="tiny-skia" version="transitive via resvg" reason="2D rendering backend for resvg. Provides Pixmap type and rendering primitives." />
          <dep name="fontdb" version="transitive via usvg" reason="Font database and loading system. Searches system font directories, handles fallbacks. KEY FOCUS FOR THIS STORY." />
        </transitive>
      </rust>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Zero Panics Policy: All font loading/configuration operations must return Result&lt;T, DotmaxError&gt;. Missing fonts or invalid configurations must fail gracefully, not panic.</constraint>
    <constraint>Backward Compatibility: Default behavior must remain unchanged. If SvgOptions API added (AC5), existing load_svg_from_path() and load_svg_from_bytes() functions must work exactly as before.</constraint>
    <constraint>Performance: Font configuration overhead must be &lt;10ms compared to current implementation (target from AC4). Measure with benchmarks.</constraint>
    <constraint>Platform Differences: Linux fonts in /usr/share/fonts, Windows in C:\Windows\Fonts, macOS in /System/Library/Fonts. fontdb should handle automatically via load_system_fonts().</constraint>
    <constraint>Feature Gate: SVG support is behind 'svg' feature flag. New font configuration must also respect this gate (no changes to core).</constraint>
    <constraint>Braille Resolution Constraint: Text smaller than 3-4 braille cells (6-8 pixels) may be illegible regardless of font quality. Document minimum font size recommendations.</constraint>
    <constraint>Code Quality: All code must pass 'cargo clippy --features svg,image -- -D warnings', be formatted with rustfmt, and maintain >80% test coverage for critical paths.</constraint>
  </constraints>

  <interfaces>
    <interface name="load_svg_from_path" kind="function" signature="pub fn load_svg_from_path(path: &amp;Path, width: u32, height: u32) -&gt; Result&lt;DynamicImage, DotmaxError&gt;"
              path="src/image/svg.rs:182-210"
              note="Current API loads SVG from file. If AC5 implemented, may add load_svg_from_path_with_options() variant that accepts SvgOptions parameter." />

    <interface name="load_svg_from_bytes" kind="function" signature="pub fn load_svg_from_bytes(bytes: &amp;[u8], width: u32, height: u32) -&gt; Result&lt;DynamicImage, DotmaxError&gt;"
              path="src/image/svg.rs:259-295"
              note="Current API loads SVG from bytes. If AC5 implemented, may add load_svg_from_bytes_with_options() variant." />

    <interface name="rasterize_svg_tree" kind="function (internal)" signature="fn rasterize_svg_tree(tree: &amp;usvg::Tree, width: u32, height: u32) -&gt; Result&lt;DynamicImage, DotmaxError&gt;"
              path="src/image/svg.rs:318-407"
              note="Internal rasterization helper. May modify to accept fontdb parameter if AC4 research shows explicit font configuration improves quality." />

    <interface name="fontdb::Database" kind="external API" signature="struct Database { ... } impl Database { pub fn new() -&gt; Self; pub fn load_system_fonts(&amp;mut self); pub fn load_fonts_dir(&amp;mut self, path); }"
              path="external crate: fontdb"
              note="Font database from fontdb crate (transitive dependency via usvg). Research (AC2) will evaluate if explicit configuration via this API improves text quality." />

    <interface name="usvg::Tree::postprocess" kind="external API" signature="pub fn postprocess(&amp;mut self, steps: PostProcessingSteps, fontdb: &amp;fontdb::Database)"
              path="external crate: usvg"
              note="Current code calls postprocess with empty fontdb::Database::new(). May need to pass configured fontdb with loaded fonts." />
  </interfaces>

  <tests>
    <standards>
Dotmax testing standards (from architecture.md and Epic 2/3 patterns):
- Unit Tests: In-module #[cfg(test)] blocks, test individual functions in isolation, >80% coverage for critical paths
- Integration Tests: tests/ directory, test complete pipelines end-to-end, verify all formats work
- Zero Panics: All test error paths verify Result&lt;T, E&gt; returned, no panic!() in production code
- Visual Validation: Manual testing required for subjective quality (automated tests miss visual regressions)
- Benchmarking: criterion.rs for performance tests, track regressions in CI
- CI Testing: All tests run on Linux, Windows, macOS with stable Rust and MSRV 1.70
- Feature Gates: Test with and without features (cargo test --features svg vs cargo test --no-default-features)

Font-specific testing for this story:
- Test that text-heavy SVGs render without panic (AC8)
- Test font fallback when specified font missing (AC8)
- Verify text elements visible in output, not blank (AC8)
- Verify text distinguishable from background (AC8)
- Manual validation with real SVGs: diagrams, logos with text (AC9)
    </standards>

    <locations>
      <location>tests/image_rendering_tests.rs - Integration tests for SVG rendering (will add font-specific tests here per AC8)</location>
      <location>src/image/svg.rs:409-548 - Unit tests for SVG module (may add font configuration tests if AC4 implemented)</location>
      <location>tests/test_assets/svg_font_tests/ - NEW: Font test SVG assets to create per AC3 (simple_text.svg, mixed_fonts.svg, small_text.svg, fallback_font.svg, bold_italic.svg)</location>
      <location>examples/svg_font_quality.rs - NEW: Font quality example to create per AC7 (or update examples/svg_demo.rs)</location>
      <location>benches/svg_rendering.rs - Performance benchmarks for SVG rasterization (verify <10ms overhead per AC4)</location>
    </locations>

    <ideas>
      <idea ac="AC1" desc="Test current font rendering with text-heavy SVG (e.g., flowchart with labels). Capture terminal output, compare to browser rendering. Identify specific quality issues (blurry, wrong font, missing glyphs)."/>
      <idea ac="AC2" desc="Create test harness that loads same SVG with different fontdb configurations: (1) default (current), (2) explicit load_system_fonts(), (3) specific font directories. Compare visual quality."/>
      <idea ac="AC3" desc="Font test SVGs should cover edge cases: very small text (6pt), multiple fonts in one SVG, missing font family (tests fallback), bold/italic (tests font variants), common fonts (Arial, Helvetica) vs uncommon fonts."/>
      <idea ac="AC4" desc="If fontdb explicit configuration helps: test that system font directories are found on Linux (/usr/share/fonts), Windows (C:\Windows\Fonts), macOS (/Library/Fonts). Verify cross-platform consistency."/>
      <idea ac="AC5" desc="If SvgOptions API needed: test that load_svg_with_options(path, width, height, options) and original load_svg(path, width, height) produce same output when options = SvgOptions::default()."/>
      <idea ac="AC8" desc="Integration test: render simple_text.svg, assert output grid contains dots (not blank), assert some dots are set to true (text visible). Test fallback_font.svg with font that doesn't exist, assert no panic and fallback used."/>
      <idea ac="AC9" desc="Manual validation: Create real-world test cases (UML diagram SVG, logo with text, technical diagram). Render before/after any improvements. Capture screenshots or save terminal output to files for comparison."/>
    </ideas>
  </tests>
</story-context>
