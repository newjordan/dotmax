<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>4</storyId>
    <title>Set Up Code Quality Tooling (Clippy, Rustfmt, Deny)</title>
    <status>drafted</status>
    <generatedAt>2025-11-17</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-4-set-up-code-quality-tooling-clippy-rustfmt-deny.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer maintaining clean, idiomatic Rust code</asA>
    <iWant>automated linting, formatting, and policy enforcement</iWant>
    <soThat>code quality remains high even after long gaps in development</soThat>
    <tasks>
- [ ] Task 1: Create Clippy configuration (AC: #1, #4, #9)
  - [ ] Create `clippy.toml` in project root
  - [ ] Enable `all = "deny"` for all clippy lints
  - [ ] Set `pedantic = "warn"` for strict code quality
  - [ ] Set `nursery = "warn"` for experimental lints
  - [ ] Set `cargo = "warn"` for Cargo-specific lints
  - [ ] Run `cargo clippy` locally to verify configuration
  - [ ] Fix any clippy warnings in existing code (src/lib.rs)

- [ ] Task 2: Create Rustfmt configuration (AC: #2, #5)
  - [ ] Create `.rustfmt.toml` in project root
  - [ ] Set `edition = "2021"` to match Cargo.toml
  - [ ] Configure `max_width = 100` for reasonable line length
  - [ ] Set `hard_tabs = false` and `tab_spaces = 4` for consistency
  - [ ] Run `cargo fmt` to format existing code
  - [ ] Run `cargo fmt --check` to verify no formatting changes needed

- [ ] Task 3: Install and configure cargo-deny (AC: #3, #6)
  - [ ] Install cargo-deny: `cargo install cargo-deny`
  - [ ] Initialize config: `cargo deny init` (creates .deny.toml)
  - [ ] Configure `[licenses]` section to deny GPL/AGPL
  - [ ] Configure `[advisories]` section for security scanning
  - [ ] Configure `[bans]` section to detect duplicate dependencies
  - [ ] Run `cargo deny check` to verify configuration works
  - [ ] Fix any deny violations (update dependencies if needed)

- [ ] Task 4: Update CI to enforce quality checks (AC: #7, #8, #9)
  - [ ] Edit `.github/workflows/ci.yml` from Story 1.2
  - [ ] Add clippy job: `cargo clippy --all-targets --all-features -- -D warnings`
  - [ ] Add fmt job: `cargo fmt --all -- --check`
  - [ ] Add deny job: `cargo deny check advisories licenses bans`
  - [ ] Ensure jobs run on all platforms or ubuntu-latest (deny/fmt)
  - [ ] Test CI by pushing changes and verifying jobs pass

- [ ] Task 5: Document quality tools for contributors (AC: #10)
  - [ ] Add "Code Quality" section to README.md or create CONTRIBUTING.md
  - [ ] Document how to run `cargo clippy` locally
  - [ ] Document how to run `cargo fmt` locally
  - [ ] Document how to run `cargo deny check` locally
  - [ ] Explain what each tool does and why it matters
  - [ ] Include installation instructions for cargo-deny
    </tasks>
  </story>

  <acceptanceCriteria>
1. `clippy.toml` configuration file exists with pedantic linting rules enabled
2. `.rustfmt.toml` configuration file exists with consistent formatting rules
3. `.deny.toml` configuration file exists blocking GPL/AGPL licenses and detecting security advisories
4. `cargo clippy` runs without warnings on current codebase
5. `cargo fmt --check` passes (all code is properly formatted)
6. `cargo deny check` passes (licenses, advisories, duplicates validated)
7. CI pipeline (from Story 1.2) enforces all three checks on every push
8. CI fails if any quality tool reports violations or warnings
9. `cargo clippy` uses `--deny warnings` flag in CI (warnings = failures)
10. Documentation in README.md or CONTRIBUTING.md explains how to run quality checks locally
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Code Organization</section>
        <snippet>Code quality standards and Rust idioms, naming conventions, error handling patterns, import organization</snippet>
      </artifact>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>NFR-M3-Code-Quality</section>
        <snippet>No compiler warnings, Clippy enforced, Rustfmt required. Rust idioms followed (ownership, borrowing, explicit lifetimes)</snippet>
      </artifact>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>NFR-L1-Open-Source-License</section>
        <snippet>Dual MIT/Apache-2.0 licensing requirement, corporate-friendly licensing for maximum adoption</snippet>
      </artifact>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>NFR-L3-Dependency-Licenses</section>
        <snippet>Permissive licenses only, no GPL/AGPL. All dependencies must use MIT, Apache-2.0, or BSD licenses</snippet>
      </artifact>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>NFR-S3-Dependency-Security</section>
        <snippet>cargo-audit/deny in CI pipeline to detect vulnerabilities and enforce license policy</snippet>
      </artifact>
      <artifact>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>NFR-M3</section>
        <snippet>Clippy lints enforced (pedantic level where reasonable), Rustfmt CI-enforced, no compiler warnings on stable Rust</snippet>
      </artifact>
      <artifact>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification</title>
        <section>Non-Functional Requirements</section>
        <snippet>Security, reliability, maintainability requirements. Zero-panic mandate and code quality standards from ADR 0007</snippet>
      </artifact>
      <artifact>
        <path>docs/sprint-artifacts/1-2-configure-github-actions-cicd-pipeline.md</path>
        <title>Story 1.2 Documentation</title>
        <section>CI Pipeline Infrastructure</section>
        <snippet>Existing CI workflow at .github/workflows/ci.yml that needs to be extended with quality enforcement jobs</snippet>
      </artifact>
      <artifact>
        <path>docs/dependencies.md</path>
        <title>Dependency Justifications</title>
        <section>Core and Optional Dependencies</section>
        <snippet>Comprehensive justification for ratatui (0.29), crossterm (0.29), thiserror (2.0), tracing (0.1) and optional dependencies. License compliance information</snippet>
      </artifact>
    </docs>
    <code>
      <artifact>
        <path>Cargo.toml</path>
        <kind>manifest</kind>
        <symbol>N/A</symbol>
        <lines>1-34</lines>
        <reason>Package manifest with edition 2021, MSRV 1.70, and all dependency definitions. Will be modified to add [lints.clippy] section for clippy configuration</reason>
      </artifact>
      <artifact>
        <path>src/lib.rs</path>
        <kind>module</kind>
        <symbol>N/A</symbol>
        <lines>1-25</lines>
        <reason>Main library entry point with basic structure and test. Will need to pass clippy linting and rustfmt formatting checks after quality tools are configured</reason>
      </artifact>
      <artifact>
        <path>.github/workflows/ci.yml</path>
        <kind>workflow</kind>
        <symbol>N/A</symbol>
        <lines>1-92</lines>
        <reason>Existing CI pipeline from Story 1.2 with test, clippy, fmt, audit, and MSRV jobs. Already has clippy and fmt jobs but needs cargo-deny job added for license/security scanning</reason>
      </artifact>
    </code>
    <dependencies>
      <rust>
        <package name="ratatui" version="0.29" scope="required">Terminal UI framework</package>
        <package name="crossterm" version="0.29" scope="required">Cross-platform terminal I/O</package>
        <package name="thiserror" version="2.0" scope="required">Error handling derive macros</package>
        <package name="tracing" version="0.1" scope="required">Structured logging</package>
        <package name="image" version="0.25" scope="optional-feature-gated">Image loading (feature: image)</package>
        <package name="imageproc" version="0.24" scope="optional-feature-gated">Image processing (feature: image)</package>
        <package name="resvg" version="0.38" scope="optional-feature-gated">SVG rasterization (feature: svg)</package>
        <package name="usvg" version="0.38" scope="optional-feature-gated">SVG parsing (feature: svg)</package>
        <package name="criterion" version="0.7" scope="dev">Benchmarking with HTML reports</package>
        <package name="tracing-subscriber" version="0.3" scope="dev">Logging in tests</package>
      </rust>
      <tools>
        <tool name="cargo-deny" install="cargo install cargo-deny">License and security policy enforcement tool</tool>
        <tool name="clippy" install="rustup component add clippy">Rust linting tool (usually pre-installed)</tool>
        <tool name="rustfmt" install="rustup component add rustfmt">Rust formatting tool (usually pre-installed)</tool>
      </tools>
    </dependencies>
  </artifacts>

  <constraints>
- **Clippy Configuration Strategy**: Recommendation is to add [lints.clippy] section to Cargo.toml rather than creating separate clippy.toml file to keep configuration centralized
- **Lint Levels**: `all = "deny"` treats all clippy lints as errors. `pedantic = "warn"`, `nursery = "warn"`, and `cargo = "warn"` provide strict quality checks without blocking valid code patterns
- **Rustfmt Settings**: Must match Rust 2021 edition. max_width = 100 balances readability with reasonable line length
- **License Policy**: Dual MIT/Apache-2.0 requires blocking GPL/AGPL dependencies. cargo-deny enforces this in CI
- **Security Scanning**: cargo-deny checks RustSec advisory database for known CVEs and fails CI if vulnerabilities found
- **Duplicate Dependencies**: Set to "warn" (not "deny") initially as duplicates are common in Rust ecosystem. Can be investigated with `cargo tree --duplicates`
- **CI Integration**: Use EmbarkStudios/cargo-deny-action@v1 GitHub Action for cargo-deny to handle installation automatically
- **Platform Requirements**: fmt and deny jobs only need ubuntu-latest as they are platform-agnostic. clippy should run with --all-targets --all-features to catch feature-gated code issues
- **MSRV Compatibility**: All quality tools must work with Rust 1.70+ (MSRV documented in Cargo.toml)
  </constraints>

  <interfaces>
    <interface>
      <name>Clippy Linting</name>
      <kind>CLI</kind>
      <signature>cargo clippy --all-targets --all-features -- -D warnings</signature>
      <path>N/A</path>
    </interface>
    <interface>
      <name>Rustfmt Formatting</name>
      <kind>CLI</kind>
      <signature>cargo fmt --all -- --check</signature>
      <path>N/A</path>
    </interface>
    <interface>
      <name>cargo-deny Checks</name>
      <kind>CLI</kind>
      <signature>cargo deny check advisories licenses bans</signature>
      <path>N/A</path>
    </interface>
    <interface>
      <name>GitHub Actions Clippy Job</name>
      <kind>CI Workflow</kind>
      <signature>runs-on: ubuntu-latest, uses: dtolnay/rust-toolchain@stable with clippy component</signature>
      <path>.github/workflows/ci.yml</path>
    </interface>
    <interface>
      <name>GitHub Actions Rustfmt Job</name>
      <kind>CI Workflow</kind>
      <signature>runs-on: ubuntu-latest, uses: dtolnay/rust-toolchain@stable with rustfmt component</signature>
      <path>.github/workflows/ci.yml</path>
    </interface>
    <interface>
      <name>GitHub Actions cargo-deny Job</name>
      <kind>CI Workflow</kind>
      <signature>runs-on: ubuntu-latest, uses: EmbarkStudios/cargo-deny-action@v1</signature>
      <path>.github/workflows/ci.yml</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
Quality tests for this story focus on linting, formatting, and policy enforcement rather than functional code testing since no functional code is being added. Testing approach:
- **Linting**: Run `cargo clippy --all-targets --all-features -- -D warnings` to ensure all clippy checks pass with warnings treated as errors
- **Formatting**: Run `cargo fmt --all -- --check` to verify all code is properly formatted without manual modifications needed
- **License/Security**: Run `cargo deny check` with three categories: advisories (security vulnerabilities), licenses (GPL/AGPL blocking), bans (duplicate dependencies)
- **CI Enforcement**: All quality checks must pass in CI pipeline or build fails
- **Negative Testing**: Intentionally introduce violations (clippy warning, format issue, invalid license) and verify CI catches them
    </standards>
    <locations>
- CI pipeline: .github/workflows/ci.yml (clippy, fmt, deny jobs)
- Local execution: Run quality tools from project root before committing
    </locations>
    <ideas>
- **AC#1 Test**: Verify clippy.toml exists OR Cargo.toml contains [lints.clippy] section with all, pedantic, nursery, cargo lint levels configured
- **AC#2 Test**: Verify .rustfmt.toml exists with edition 2021, max_width 100, hard_tabs false, tab_spaces 4
- **AC#3 Test**: Verify .deny.toml exists with [licenses] denying GPL/AGPL, [advisories] section for security, [bans] for duplicates
- **AC#4 Test**: Run `cargo clippy --all-targets --all-features` locally and verify exit code 0 (no warnings on current codebase - src/lib.rs with basic test)
- **AC#5 Test**: Run `cargo fmt --check` locally and verify exit code 0 (all code already formatted)
- **AC#6 Test**: Run `cargo deny check` locally and verify exit code 0 (no license violations, no security advisories, duplicates only warn)
- **AC#7 Test**: Push code to GitHub and verify CI runs clippy, fmt, and deny jobs in addition to existing test/audit/MSRV jobs
- **AC#8 Test**: Introduce a clippy warning (e.g., unused variable), push code, verify CI fails with clear error message
- **AC#9 Test**: Verify CI clippy job uses `-- -D warnings` flag (check .github/workflows/ci.yml line 48)
- **AC#10 Test**: Verify README.md or CONTRIBUTING.md contains Code Quality section with instructions for running clippy, fmt, deny locally, plus cargo-deny installation instructions
- **Negative Test 1**: Add `#[allow(warnings)]` to code, verify clippy in CI still enforces quality (pedantic/nursery warnings shown but not failing CI)
- **Negative Test 2**: Mis-format code intentionally, run `cargo fmt --check`, verify exit code 1 (formatting violations detected)
- **Negative Test 3**: Pin a dependency with known vulnerability (if any), run `cargo deny check advisories`, verify it catches the issue
    </ideas>
  </tests>
</story-context>
